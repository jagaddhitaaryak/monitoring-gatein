<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InDeCo - Integrated Delivery Control System</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- 1. THEME VARIABLES --- */
        :root {
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --sidebar-bg: #0f172a; 
            --sidebar-hover: #1e293b;
            --sidebar-active: #2563eb;
            --header-bg: #0f172a; 
            --header-height: 64px;
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 70px;
            --footer-height: 40px;
            --text-main: #334155;
            --text-muted: #64748b;
            --text-light: #f8fafc;
            --color-primary: #2563eb;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --blue-header: #172554; --blue-row: #eff6ff;
            --orange-header: #9a3412; --orange-row: #fff7ed;
            --green-header: #064e3b; --green-row: #f0fdf4;
            --dark-header: #0f172a; --dark-row: #f8fafc;
        }

        /* --- 2. GLOBAL RESET --- */
        * { box-sizing: border-box; outline: none; }
        body { 
            margin: 0; 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* WRAPPER FOR DASHBOARD APP */
        #app-container {
            display: none; 
            min-height: 100vh;
        }
        #app-container.active {
            display: flex;
        }

        /* --- LOGIN PAGE STYLES --- */
        #login-page {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            z-index: 9999;
            display: none; 
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 1; 
            transition: opacity 0.5s ease;
        }

        .login-card {
            background: white;
            width: 900px;
            max-width: 100%;
            height: 550px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            display: flex;
            overflow: hidden;
        }

        .login-visual {
            flex: 1;
            background: #f1f5f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            position: relative;
            border-right: 1px solid #e2e8f0;
        }

        .truck-illustration {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            margin-bottom: 30px;
        }
        .truck-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.8;
            transition: transform 0.3s;
        }
        .truck-item:hover { transform: translateY(-5px); opacity: 1; }
        .truck-item i { font-size: 2.5rem; color: #334155; margin-bottom: 5px; }
        .truck-item span { font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; }

        .login-form-container {
            flex: 1;
            padding: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .login-logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        .custom-logo-svg { width: 40px; height: 40px; }
        .app-title-login { font-size: 1.5rem; font-weight: 800; color: #0f172a; letter-spacing: -0.5px; }

        .form-group { margin-bottom: 20px; }
        .form-group label { font-size: 0.8rem; font-weight: 600; color: #475569; margin-bottom: 8px; display: block; }
        .form-input { 
            width: 100%; padding: 12px 15px; border: 2px solid #e2e8f0; 
            border-radius: 8px; font-size: 0.9rem; transition: 0.3s; 
        }
        .form-input:focus { border-color: var(--color-primary); }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 10px;
        }
        .btn-login:hover { background: #1d4ed8; transform: translateY(-2px); }
        .login-footer { margin-top: auto; text-align: center; font-size: 0.75rem; color: #94a3b8; padding-top: 20px; }

        @media (max-width: 768px) {
            .login-card { flex-direction: column; height: auto; }
            .login-visual { display: none; }
            .login-form-container { padding: 30px; }
        }

        /* --- 3. SIDEBAR --- */
        .sidebar { 
            width: var(--sidebar-width); 
            background: var(--sidebar-bg); 
            color: var(--text-light); 
            position: fixed; 
            left: 0; top: 0; bottom: 0; 
            z-index: 1000; 
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; 
            flex-direction: column;
            box-shadow: 4px 0 24px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        .sidebar-brand { 
            height: var(--header-height); 
            display: flex; 
            align-items: center; 
            padding: 0 1.5rem; 
            font-weight: 800; 
            font-size: 1.2rem; 
            letter-spacing: 0.5px;
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            white-space: nowrap;
            background: rgba(0,0,0,0.2); 
        }
        .brand-icon-svg { width: 30px; height: 30px; margin-right: 12px; }
        .sidebar-menu { flex: 1; padding-top: 1rem; overflow-y: auto; }
        .sidebar-menu::-webkit-scrollbar { width: 4px; }
        .sidebar-menu::-webkit-scrollbar-thumb { background: #334155; }
        .menu-label { padding: 1rem 1.5rem 0.5rem; font-size: 0.65rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 1px; white-space: nowrap; }
        .nav-item { 
            display: flex; align-items: center; padding: 0.85rem 1.5rem; color: #94a3b8; 
            text-decoration: none; font-size: 0.85rem; font-weight: 500; transition: all 0.2s; 
            border-left: 3px solid transparent; cursor: pointer; white-space: nowrap;
        }
        .nav-item i { width: 24px; text-align: center; margin-right: 12px; font-size: 1rem; }
        .nav-item:hover { color: white; background: var(--sidebar-hover); }
        .nav-item.active { background: rgba(37, 99, 235, 0.1); color: #60a5fa; border-left-color: var(--color-primary); }

        body.sidebar-hidden .sidebar { width: var(--sidebar-collapsed-width); }
        body.sidebar-hidden .sidebar-brand span, 
        body.sidebar-hidden .menu-label,
        body.sidebar-hidden .nav-item span { display: none; opacity: 0; }
        body.sidebar-hidden .nav-item { padding: 0.85rem 0; justify-content: center; }
        body.sidebar-hidden .nav-item i { margin-right: 0; font-size: 1.2rem; }
        body.sidebar-hidden .sidebar-brand { justify-content: center; padding: 0; }
        body.sidebar-hidden .sidebar-brand .brand-icon-svg { margin: 0; }

        body.sidebar-hidden .nav-item:hover::after {
            content: attr(data-tooltip);
            position: absolute; left: 100%; top: 50%; transform: translateY(-50%);
            background: #1e293b; color: white; padding: 6px 10px; border-radius: 4px;
            font-size: 0.75rem; white-space: nowrap; z-index: 2000; margin-left: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* --- 4. HEADER --- */
        header { 
            position: fixed; 
            top: 0; right: 0; 
            left: var(--sidebar-width); 
            height: var(--header-height); 
            background: var(--header-bg); 
            color: white; 
            display: flex; 
            align-items: center; 
            padding: 0 1.5rem; 
            z-index: 900; 
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            justify-content: space-between; 
        }
        body.sidebar-hidden header { left: var(--sidebar-collapsed-width); }

        .header-left { display: flex; align-items: center; }
        .toggle-btn { 
            background: rgba(255,255,255,0.1); 
            border: 1px solid rgba(255,255,255,0.2);
            color: white; 
            border-radius: 6px; width: 32px; height: 32px; 
            cursor: pointer; margin-right: 15px; 
            transition: 0.2s;
        }
        .toggle-btn:hover { background: rgba(255,255,255,0.2); }

        .header-titles { display: flex; flex-direction: column; }
        .header-titles h1 { font-size: 1rem; margin: 0; font-weight: 700; letter-spacing: 0.5px; color: white; }
        .header-titles h2 { font-size: 0.75rem; margin: 0; color: #94a3b8; font-weight: 400; }

        .header-right { margin-left: auto; display: flex; align-items: center; }
        .btn-logout {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #fca5a5;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-logout:hover { background: #ef4444; color: white; }

        /* --- 5. MAIN CONTENT & FOOTER --- */
        .main-content { 
            margin-left: var(--sidebar-width); 
            padding: calc(var(--header-height) + 20px) 20px calc(var(--footer-height) + 20px); 
            flex-grow: 1; 
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            width: 100%;
        }
        body.sidebar-hidden .main-content { margin-left: var(--sidebar-collapsed-width); }

        footer { 
            position: fixed; 
            bottom: 0; right: 0; 
            left: var(--sidebar-width); 
            height: var(--footer-height);
            background: white; 
            border-top: 1px solid #e2e8f0;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem; color: #64748b; 
            z-index: 950;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body.sidebar-hidden footer { left: var(--sidebar-collapsed-width); }

        /* --- 6. STATS & ICONS --- */
        .dash-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .dash-stat-card { 
            background: white; padding: 20px; border-radius: 12px; 
            box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0; 
            position: relative; overflow: hidden; height: 120px; 
            display: flex; flex-direction: column; justify-content: space-between;
            transition: transform 0.2s;
        }
        .dash-stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .dash-stat-card .icon-bg { position: absolute; right: -5px; top: -5px; font-size: 4.5rem; opacity: 0.25; }
        
        .dsc-green { border-bottom: 4px solid #22c55e; } .dsc-green .icon-bg { color: #22c55e; } .dsc-green .dash-stat-value { color: #15803d; }
        .dsc-blue { border-bottom: 4px solid #3b82f6; } .dsc-blue .icon-bg { color: #3b82f6; } .dsc-blue .dash-stat-value { color: #1d4ed8; }
        .dsc-orange { border-bottom: 4px solid #f97316; } .dsc-orange .icon-bg { color: #f97316; } .dsc-orange .dash-stat-value { color: #c2410c; }
        .dsc-purple { border-bottom: 4px solid #a855f7; } .dsc-purple .icon-bg { color: #a855f7; } .dsc-purple .dash-stat-value { color: #7e22ce; }

        .dash-stat-title { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 5px; position: relative; z-index: 2; }
        .dash-stat-value { font-size: 1.8rem; font-weight: 800; position: relative; z-index: 2; }

        /* --- 7. TABLE STYLES --- */
        .table-responsive { 
            width: 100%; 
            overflow-x: auto; 
            border: 1px solid #334155; 
            background: #ffffff;
            margin-bottom: 10px;
            -webkit-overflow-scrolling: touch; 
        }

        .main-data-table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 1000px; 
        }

        .main-data-table th, 
        .main-data-table td { 
            padding: 8px 6px; 
            border: 2px solid #cbd5e1;
            font-size: 0.75rem; 
            text-align: center !important; 
            vertical-align: middle !important; 
            white-space: normal !important; 
            word-wrap: break-word !important; 
            line-height: 1.3;
        }

        .main-data-table th { 
            background: #06887b !important; 
            color: #ffffff !important; 
            text-transform: uppercase;
            font-weight: 700;
            border: 2px solid #334155 !important;
            height: 40px;
        }

        /* --- KHUSUS HISTORY TABLE STYLE --- */
        .history-card-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            border: none;
            padding: 25px;
            width: 100%;
        }

        .history-header-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #343a40;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .history-controls-left { display: flex; gap: 15px; align-items: flex-end; }
        .history-controls-right { display: flex; gap: 10px; }

        #table-history-data th {
            background-color: #008080 !important; 
            border: 1px solid #006666 !important;
            color: white !important;
            padding: 12px;
            font-size: 0.8rem;
        }

        /* Responsive Column Widths */
        .main-data-table th:nth-child(1), .main-data-table td:nth-child(1) { width: 40px; }
        .main-data-table th:nth-child(2), .main-data-table td:nth-child(2) { width: 40px; }
        
        .main-data-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* STATUS PILL STYLE */
        .status-pill { 
            padding: 4px 8px; 
            border-radius: 8px; 
            font-size: 0.65rem; 
            font-weight: 800; 
            text-transform: uppercase; 
            display: inline-block; 
            text-align: center; 
            white-space: normal !important; 
            word-break: break-word;
            min-width: 80px; 
            line-height: 1.2;
        }

        .status-planning { background: #dbeafe; color: #1e40af; border: 1px solid #fdac93; }
        .status-gatein { background: #fef08a; color: #854d0e; border: 1px solid #facc15; }
        .status-cancelled { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        .col-number { text-align: center !important; font-weight: 800 !important; color: #0f172a; }
        
        .main-data-table tr:hover td { background-color: #e2e8f0; }
        .main-data-table tr:nth-child(even) { background-color: #f8fafc; }

        .main-data-table .btn, .main-data-table .btn-action { margin: 0 auto; display: inline-flex; }

        /* --- 8. COMPONENTS --- */
        .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow-sm); border: 1px solid #e2e8f0; }
        .dash-charts-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: var(--shadow-sm); min-height: 400px; display: flex; flex-direction: column; }
        .chart-full-width { grid-column: 1 / -1; min-height: 450px; }
        .chart-title { font-size: 0.85rem; font-weight: 700; color: #1e293b; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; }
        .canvas-wrapper { flex: 1; position: relative; width: 100%; }

        input, select, textarea { width: 100%; padding: 8px 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.85rem; background: #fff; }
        label { font-size: 0.7rem; font-weight: 700; color: #475569; margin-bottom: 4px; display: block; }

        .btn { padding: 8px 14px; border-radius: 6px; font-weight: 600; font-size: 0.75rem; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; text-transform: uppercase; }
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }
        .btn-primary { background: var(--color-primary); color: white; }
        .btn-white { background: white; border: 1px solid #cbd5e1; color: #334155; }
        .btn-pro-save { background: #334155; color: white; }
        .btn-pro-excel { background: #059669; color: white; }
        .btn-pro-reset { background: #dc2626; color: white; }
        
        .btn-action { 
            width: 26px; height: 26px; 
            border-radius: 4px; border:none; 
            color:white; cursor:pointer; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .btn-edit { background: var(--color-primary); }

        .dash-filter-bar, .analysis-control-bar, .history-controls { background: white; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 20px; }

        /* --- SMART FILTER CSS --- */
        .smart-filter-box {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .sf-header {
            font-size: 0.75rem;
            font-weight: 800;
            color: var(--color-primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
        }
        .sf-grid input, .sf-grid select {
            font-size: 0.75rem;
            padding: 8px;
            border: 1px solid #cbd5e1;
            width: 100%;
        }
        .sf-grid input:focus, .sf-grid select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        /* Analysis Tables */
        .gap-container-flex { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .gap-table-box { flex: 1; min-width: 300px; background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0; }
        
        /* --- UPDATE UKURAN FONT DI SINI --- */
        .analysis-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.95rem; /* DIPERBESAR: Sebelumnya 0.7rem */
        }
        
        .analysis-table th, .analysis-table td { 
            padding: 10px 5px; /* Padding diperlega sedikit */
            text-align: center; 
            border: 1px solid #e2e8f0; 
        }

        /* KHUSUS ANGKA DI DALAM TABEL LEBIH TEBAL & BESAR */
        .analysis-table td {
            font-weight: 600; /* Tulisan di sel jadi agak tebal */
            color: #0f172a;
        }

        /* Angka yang di-highlight (menggunakan span di JS) jadi lebih besar lagi */
        .analysis-table td span {
            font-size: 1.1rem; 
        }
        
        .table-header-title { padding: 10px; margin: 0; font-size: 0.85rem; font-weight: 800; text-transform: uppercase; color: white !important; }
        
        /* ... (lanjutan css theme colors biarkan tetap sama) ... */
        .theme-blue .table-header-title { background: #172554; } .theme-blue th { background: var(--blue-header); color:white; }
        .theme-orange .table-header-title { background: #7c2d12; } .theme-orange th { background: var(--orange-header); color:white; }
        .theme-green .table-header-title { background: #14532d; } .theme-green th { background: var(--green-header); color:white; }
        .theme-dark .table-header-title { background: #1e293b; color: white; } .theme-dark th { background: var(--dark-header); color:white; }

        .gap-alert { background-color: #fee2e2 !important; color: #dc2626 !important; font-weight: 800; }
        
        /* --- NEW STATS MONITORING CSS --- */
        .stats-container {
            margin-bottom: 20px;
        }
        
        .stats-row {
            display: grid;
            gap: 15px;
            margin-bottom: 15px;
        }

        .row-3-cols {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .row-4-cols {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .stat-new-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-new-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .st-icon-box {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        .st-content {
            flex: 1;
        }

        .st-content h4 {
            margin: 0 0 2px 0;
            font-size: 0.65rem;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 700;
        }

        .st-content p {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 800;
            color: #0f172a;
        }
        
        /* Specific Colors */
        .st-plan { border-left: 4px solid #3b82f6; } .st-plan .st-icon-box { background: #eff6ff; color: #3b82f6; }
        .st-self { border-left: 4px solid #8b5cf6; } .st-self .st-icon-box { background: #f3e8ff; color: #8b5cf6; }
        .st-total { border-left: 4px solid #1e293b; } .st-total .st-icon-box { background: #f1f5f9; color: #1e293b; }
        
        .st-gate { border-left: 4px solid #10b981; } .st-gate .st-icon-box { background: #ecfdf5; color: #10b981; }
        .st-pend { border-left: 4px solid #f59e0b; } .st-pend .st-icon-box { background: #fffbeb; color: #f59e0b; }
        .st-canc { border-left: 4px solid #ef4444; } .st-canc .st-icon-box { background: #fef2f2; color: #ef4444; }
        .st-tona { border-left: 4px solid #06b6d4; } .st-tona .st-icon-box { background: #ecfeff; color: #06b6d4; }


        /* --- 9. MODALS --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-overlay.active { display: flex; }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 500px; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-top: 5px solid var(--color-primary); }

        .status-buttons-container { display: flex; gap: 15px; margin-top: 25px; justify-content: center; }
        .btn-status-opt { flex: 1; padding: 15px 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 800; font-size: 0.85rem; color: white; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; gap: 8px; }

        .btn-opt-plan { background: #1e3a8a; } .btn-opt-plan:hover { background: #1e40af; transform: translateY(-2px); }
        .btn-opt-gatein { background: #facc15; color: #713f12; } .btn-opt-gatein:hover { background: #fde047; transform: translateY(-2px); }
        .btn-opt-cancel { background: #ef4444; } .btn-opt-cancel:hover { background: #dc2626; transform: translateY(-2px); }

        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .text-outstanding { color: #c2410c; font-size: 0.65rem; font-style: italic; font-weight: 600; display: block; margin-top:2px;}
        
        /* --- MEDIA QUERIES KHUSUS MOBILE & RESPONSIVENESS --- */
        @media (max-width: 768px) {
            :root { --sidebar-collapsed-width: 0px; }
            body:not(.sidebar-hidden) .sidebar { width: 100%; max-width: 280px; }
            header { left: 0 !important; }
            .main-content { margin-left: 0 !important; padding: calc(var(--header-height) + 15px) 15px calc(var(--footer-height) + 15px); }
            footer { left: 0 !important; }
            
            /* Grid Layouts to 1 Column */
            .dash-stats-grid, .dash-charts-container { grid-template-columns: 1fr; }
            .form-grid-mobile { grid-template-columns: 1fr !important; }
            
            /* Stats Mobile */
            .row-3-cols, .row-4-cols { grid-template-columns: 1fr; }

            /* Table Optimization for Mobile */
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .main-data-table { min-width: 900px; } 

            .status-buttons-container { flex-direction: column; }
            
            /* Hide Login Illustration on Mobile */
            body[data-logged-in="true"] #login-page { display: none !important; }

             /* Adjust Table Padding */
            .main-data-table th, .main-data-table td {
                padding: 5px 2px;
                font-size: 0.7rem;
            }

            .history-controls { flex-direction: column; align-items: stretch; }
            .history-controls-left { flex-wrap: wrap; }
            .history-controls-right { justify-content: flex-end; }
        }
        /* --- CSS TAMBAHAN UNTUK 4 BOX STATISTIK ANALYSIS --- */
        .analysis-control-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap; /* Agar responsif */
            background: #f8fafc;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            margin-bottom: 20px;
        }

        /* Container untuk 4 Box Kecil */
        .stats-header-group {
            display: flex;
            gap: 10px;
            flex: 1; /* Mengisi ruang kosong di tengah */
            justify-content: center;
        }

        .stat-mini {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 6px 12px;
            min-width: 150px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .mini-icon {
            width: 32px; height: 32px;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            margin-right: 10px;
            font-size: 0.9rem;
        }

        .mini-content { display: flex; flex-direction: column; line-height: 1.1; }
        .mini-label { font-size: 0.6rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 2px; }
        .mini-value { font-size: 0.95rem; font-weight: 800; color: #0f172a; }

        /* Warna Tema Box */
        .box-blue { border-left: 3px solid #2563eb; }
        .box-blue .mini-icon { background: #eff6ff; color: #2563eb; }

        .box-green { border-left: 3px solid #16a34a; }
        .box-green .mini-icon { background: #f0fdf4; color: #16a34a; }

        .box-orange { border-left: 3px solid #ea580c; }
        .box-orange .mini-icon { background: #fff7ed; color: #ea580c; }

        .box-purple { border-left: 3px solid #9333ea; }
        .box-purple .mini-icon { background: #faf5ff; color: #9333ea; }

        /* --- MOBILE FIRST OVERRIDES --- */
        @media (max-width: 768px) {
            
            /* 1. PERBAIKAN LAYOUT UTAMA & SIDEBAR (OVERLAY MODE) */
            body { overflow-x: hidden; } /* Mencegah geser kanan-kiri yang tidak perlu */
            
            /* Sidebar sembunyi total di kiri layar */
            .sidebar {
                width: 260px !important;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                box-shadow: 5px 0 15px rgba(0,0,0,0.2);
            }
            
            /* Class baru untuk memunculkan sidebar di mobile */
            body.mobile-nav-active .sidebar {
                transform: translateX(0);
            }

            /* Header & Konten selalu full width di mobile */
            header { left: 0 !important; width: 100%; padding: 0 15px; }
            .main-content { margin-left: 0 !important; padding: 80px 15px 60px 15px; }
            footer { left: 0 !important; width: 100%; font-size: 0.65rem; }

            /* Overlay Gelap saat sidebar muncul */
            #mobile-backdrop {
                display: none;
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 999;
                backdrop-filter: blur(2px);
            }
            body.mobile-nav-active #mobile-backdrop { display: block; }

            /* 2. TYPOGRAPHY & TOUCH TARGETS */
            /* Mencegah zoom otomatis di iPhone saat ketik */
            input, select, textarea { font-size: 16px !important; padding: 10px !important; }
            
            /* Tombol lebih mudah ditekan */
            .btn, .nav-item { min-height: 44px; display: flex; align-items: center; }
            
            /* Judul lebih kecil agar muat */
            .header-titles h1 { font-size: 0.85rem; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            .header-titles h2 { font-size: 0.7rem; }

            /* 3. TABEL RESPONSIF (SCROLLABLE) */
            .table-responsive {
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                margin-bottom: 20px;
            }
            
            /* Font tabel dikecilkan sedikit tapi tetap terbaca */
            .main-data-table th, .main-data-table td {
                font-size: 0.7rem !important;
                padding: 8px 5px !important;
                white-space: nowrap; /* Mencegah teks turun ke bawah agar rapi */
            }
            
            /* Sticky Column untuk Checkbox & No (Agar tahu baris mana yg dipilih saat scroll) */
            .main-data-table th:nth-child(1), .main-data-table td:nth-child(1) {
                position: sticky; left: 0; background: #fff; z-index: 5;
                border-right: 2px solid #e2e8f0;
            }
            .main-data-table th:nth-child(1) { background: #06887b !important; }

            /* 4. FORM & MODAL */
            /* Form input menjadi 1 kolom ke bawah */
            .form-grid-mobile {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            /* Smart Filter Grid menjadi 2 kolom agar tidak terlalu panjang */
            .sf-grid { grid-template-columns: 1fr 1fr; }
            
            /* Modal Full Width di Bawah (Bottom Sheet Style) */
            .modal-box {
                width: 100%;
                max-width: 100%;
                border-radius: 20px 20px 0 0;
                position: fixed;
                bottom: 0;
                top: auto;
                left: 0;
                margin: 0;
                max-height: 85vh;
                overflow-y: auto;
                animation: slideUp 0.3s ease-out;
            }
            
            @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

            /* 5. ANALYSIS PAGE & STATS */
            .analysis-control-bar { flex-direction: column; align-items: stretch; }
            .stats-header-group { flex-wrap: wrap; }
            .stat-mini { flex: 1 1 45%; } /* Statistik jadi 2 kolom */
            
            /* Tombol aksi di monitoring bar */
            .analysis-control-bar > div {
                flex-direction: column; width: 100%;
            }
            .analysis-control-bar button { width: 100%; margin-top: 5px; }

            /* Login Page Responsive */
            .login-card { width: 95%; height: auto; padding-bottom: 30px; }
        }

        /* --- TAMBAHAN CSS UNTUK 5 KARTU --- */
        .box-teal { border-left: 3px solid #06b6d4; }
        .box-teal .mini-icon { background: #ecfeff; color: #06b6d4; }

        /* Pemisah Antara Franco & Loco */
        .stats-divider {
            width: 1px;
            background-color: #cbd5e1;
            margin: 0 10px;
            align-self: stretch; /* Agar tinggi mengikuti parent */
            display: block;
        }

        @media (max-width: 768px) {
            /* Sembunyikan garis di HP, ganti jadi jarak */
            .stats-divider { display: none; margin: 10px 0; }
        }
    </style>
</head>
<body class="sidebar-hidden">

    <div id="login-page">
        <div class="login-card">
            <div class="login-visual">
                <div class="truck-illustration">
                    <div class="truck-item">
                        <i class="fa-solid fa-truck-moving"></i>
                        <span>Tronton</span>
                    </div>
                    <div class="truck-item" style="transform: scale(1.1);">
                        <i class="fa-solid fa-truck-ramp-box"></i>
                        <span>Trailer</span>
                    </div>
                    <div class="truck-item">
                        <i class="fa-solid fa-box-open"></i>
                        <span>Cargo</span>
                    </div>
                </div>
                <h2>Integrated Delivery Control</h2>
                <p>Monitor, Plan, and Analyze Logistic Operations Efficiently.</p>
                <div style="margin-top: 30px; display: flex; gap: 10px;">
                    <div style="width: 40px; height: 5px; background: #3b82f6; border-radius: 2px;"></div>
                    <div style="width: 40px; height: 5px; background: #cbd5e1; border-radius: 2px;"></div>
                    <div style="width: 40px; height: 5px; background: #cbd5e1; border-radius: 2px;"></div>
                </div>
            </div>
            <div class="login-form-container">
                <div class="login-logo-area">
                    <svg class="custom-logo-svg" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="2" y="14" width="7" height="12" rx="2" fill="#3b82f6"/>
                        <rect x="11" y="8" width="7" height="18" rx="2" fill="#2563eb"/>
                        <rect x="20" y="2" width="7" height="24" rx="2" fill="#1e40af"/>
                    </svg>
                    <div class="app-title-login">InDeCo System</div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="margin: 0 0 5px 0; color: #1e293b;">Welcome Back</h3>
                    <span style="font-size: 0.85rem; color: #64748b;">Silahkan login untuk mengakses dashboard.</span>
                </div>

                <div class="form-group">
                    <label>Username / ID</label>
                    <input type="text" class="form-input" id="login-username" placeholder="Masukkan ID User...">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" class="form-input" id="login-password" placeholder="Masukkan Password...">
                </div>
                
                <button class="btn-login" onclick="attemptLogin()">
                    <i class="fa-solid fa-right-to-bracket"></i> LOGIN
                </button>

                <div class="login-footer">
                    &copy; 2026 Ahmad Fauzi - IKK Logistic Dept. <br> Integrated Delivery Control System v2.1
                </div>
            </div>
        </div>
    </div>

    <div id="app-container">
        <div id="mobile-backdrop" onclick="toggleSidebar()"></div> 
        <div class="sidebar">
            <div class="sidebar-brand">
                <svg class="brand-icon-svg" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="14" width="7" height="12" rx="2" fill="#3b82f6"/>
                    <rect x="11" y="8" width="7" height="18" rx="2" fill="#2563eb"/>
                    <rect x="20" y="2" width="7" height="24" rx="2" fill="white"/>
                </svg>
                <span>InDeCo System</span>
            </div>
            <div class="sidebar-menu">
                <div class="menu-label">MAIN MENU</div>
                <a onclick="showPage('dashboard', 'Executive Dashboard')" class="nav-item active" id="menu-dashboard" data-tooltip="Dashboard">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                
                <div class="menu-label">OPERATIONS</div>
                <a onclick="showPage('planning', 'Delivery Planning')" class="nav-item" id="menu-planning" data-tooltip="Planning">
                    <i class="fa-solid fa-clipboard-list"></i>
                    <span>Planning</span>
                </a>
                <a onclick="showPage('monitoring', 'Live Monitoring')" class="nav-item" id="menu-monitoring" data-tooltip="Monitoring">
                    <i class="fa-solid fa-satellite-dish"></i>
                    <span>Monitoring</span>
                </a>
                <a onclick="showPage('analysis', 'Gap Analysis')" class="nav-item" id="menu-analysis" data-tooltip="Analysis">
                    <i class="fa-solid fa-chart-pie"></i>
                    <span>Analysis</span>
                </a>
                <a onclick="showPage('history', 'Data History')" class="nav-item" id="menu-history" data-tooltip="History">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    <span>History</span>
                </a>
                
                <div class="menu-label">MASTER DATA</div>
                <a onclick="showPage('route', 'Route Master')" class="nav-item" id="menu-route" data-tooltip="Routes">
                    <i class="fa-solid fa-map-location-dot"></i>
                    <span>Routes</span>
                </a>
                <a onclick="showPage('driver', 'Driver Master')" class="nav-item" id="menu-driver" data-tooltip="Drivers">
                    <i class="fa-solid fa-id-card"></i>
                    <span>Drivers</span>
                </a>
                <a onclick="showPage('vehicle', 'Vehicle Master')" class="nav-item" id="menu-vehicle" data-tooltip="Vehicles">
                    <i class="fa-solid fa-truck-front"></i>
                    <span>Vehicles</span>
                </a>
            </div>
        </div>

        <div class="main-content">
            <header>
                <div class="header-left">
                    <button class="toggle-btn" onclick="toggleSidebar()">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <div class="header-titles">
                        <h1>InDeCo - Integrated Delivery Control System</h1>
                        <h2 id="sub-page-title">Executive Dashboard</h2>
                    </div>
                </div>
                <div class="header-right">
                    <button class="btn-logout" onclick="confirmLogout()">
                        <i class="fa-solid fa-power-off"></i> <span>Keluar</span>
                    </button>
                </div>
            </header>

            <div id="page-dashboard" class="page active">
                <div class="dash-filter-bar">
                    <label style="margin:0;">PERIODE:</label>
                    <input type="date" id="dash-start" style="width: auto;">
                    <span style="color:#94a3b8;">s/d</span>
                    <input type="date" id="dash-end" style="width: auto;">
                    <button class="btn btn-primary" onclick="renderDashboard()">
                        <i class="fa-solid fa-filter"></i> PROSES
                    </button>
                </div>
                
                <div class="dash-stats-grid">
                    <div class="dash-stat-card dsc-green">
                        <i class="fa-solid fa-handshake icon-bg"></i>
                        <div>
                            <div class="dash-stat-title">Active Vendors</div>
                            <div class="dash-stat-value" id="d-val-vendor">0</div>
                        </div>
                    </div>
                    <div class="dash-stat-card dsc-blue">
                        <i class="fa-solid fa-weight-hanging icon-bg"></i>
                        <div>
                            <div class="dash-stat-title">Total Tonase (Kg)</div>
                            <div class="dash-stat-value" id="d-val-tonase">0</div>
                        </div>
                    </div>
                    <div class="dash-stat-card dsc-orange">
                        <i class="fa-solid fa-file-invoice icon-bg"></i>
                        <div>
                            <div class="dash-stat-title">Total DN (Selesai)</div>
                            <div class="dash-stat-value" id="d-val-dn">0</div>
                        </div>
                    </div>
                    <div class="dash-stat-card dsc-purple">
                        <i class="fa-solid fa-scale-balanced icon-bg"></i>
                        <div>
                            <div class="dash-stat-title">Avg Qty / DN</div>
                            <div class="dash-stat-value" id="d-val-avg">0</div>
                        </div>
                    </div>
                </div>

                <div class="dash-charts-container">
                    <div class="chart-box">
                        <div class="chart-title"><i class="fa-solid fa-map"></i> Distribusi Area (History)</div>
                        <div class="canvas-wrapper"><canvas id="chartArea"></canvas></div>
                    </div>
                    <div class="chart-box">
                        <div class="chart-title"><i class="fa-solid fa-truck"></i> Komposisi Armada (History)</div>
                        <div class="canvas-wrapper"><canvas id="chartArmada"></canvas></div>
                    </div>
                    <div class="chart-box chart-full-width">
                        <div class="chart-title"><i class="fa-solid fa-trophy"></i> Top 5 Customer (History)</div>
                        <div class="canvas-wrapper"><canvas id="chartCustomer"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="page-planning" class="page">
                <div class="card">
                    <div style="border-bottom: 1px solid #e2e8f0; margin-bottom: 20px; padding-bottom: 10px;">
                        <h3 style="margin:0; color:var(--text-main);"><i class="fa-solid fa-file-excel"></i> Buat Planning (Copy-Paste Excel)</h3>
                    </div>

                    <datalist id="list-history-vendor"></datalist>
                    <datalist id="list-history-catatan"></datalist>
                    <datalist id="list-area-options">
                        <option value="JABODETABEK">
                        <option value="JAWA TENGAH">
                        <option value="JAWA TIMUR">
                        <option value="LUAR PULAU">
                        <option value="AMBIL SENDIRI">
                    </datalist>

                    <div class="form-grid-mobile" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label>Pickup Date (Wajib)</label>
                            <input type="date" id="p-bulk-date">
                        </div>
                        <div>
                            <label>Vendor / Transporter</label>
                            <input type="text" id="p-bulk-vendor" list="list-history-vendor" placeholder="Pilih / Ketik...">
                        </div>
                        <div>
                            <label>Area Tujuan</label>
                            <input type="text" id="p-bulk-area" list="list-area-options" placeholder="Pilih Area...">
                        </div>
                        <div>
                            <label>Catatan Tambahan</label>
                            <input type="text" id="p-bulk-catatan" list="list-history-catatan" placeholder="Cth: Urgent / Next Day">
                        </div>
                    </div>
                    
                    <label>Data Excel (Copy dari Excel kolom DN s/d Ket, lalu Paste di sini)</label>
                    <textarea id="p-bulk-data" style="height: 200px; margin-bottom: 15px;" placeholder="Paste data excel di sini..."></textarea>
                    
                    <div style="text-align: right;">
                        <button class="btn btn-primary" onclick="processBulkPlanning()">
                            <i class="fa-solid fa-upload"></i> SUBMIT EXCEL PLANNING
                        </button>
                    </div>

                    <div style="margin: 30px 0; border-top: 2px dashed #e2e8f0; position: relative;">
                        <span style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: white; padding: 0 10px; color: #64748b; font-weight: 600; font-size: 0.8rem;">ATAU INPUT SATUAN</span>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <h3 style="margin:0 0 15px 0; color:var(--text-main);"><i class="fa-solid fa-pen-to-square"></i> Input Manual (Single Entry)</h3>
                    </div>

                    <div class="form-grid-mobile" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label>Pickup Date *</label>
                            <input type="date" id="m-date">
                        </div>
                        <div>
                            <label>Vendor / Transporter</label>
                            <input type="text" id="m-vendor" list="list-history-vendor" placeholder="Nama Vendor...">
                        </div>
                         <div>
                            <label>Area Tujuan</label>
                            <input type="text" id="m-area" list="list-area-options" placeholder="Pilih Area...">
                        </div>
                    </div>

                    <div class="form-grid-mobile" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label>No DN (Delivery Note) *</label>
                            <input type="text" id="m-dn" placeholder="No. DN">
                        </div>
                        <div>
                            <label>No SN (Shipment) *</label>
                            <input type="text" id="m-sn" placeholder="No. SN">
                        </div>
                        <div>
                            <label>Customer Name</label>
                            <input type="text" id="m-customer" placeholder="Nama Customer">
                        </div>
                    </div>

                    <div class="form-grid-mobile" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label>Kota Tujuan</label>
                            <input type="text" id="m-city" placeholder="Nama Kota">
                        </div>
                         <div>
                            <label>Qty Utama (Kg)</label>
                            <input type="number" id="m-qty" placeholder="0">
                        </div>
                         <div>
                            <label>Catatan</label>
                            <input type="text" id="m-catatan" list="list-history-catatan" placeholder="Keterangan...">
                        </div>
                    </div>

                    <div class="form-grid-mobile" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="color: #2563eb;">(+) Tambah DN (Optional)</label>
                            <input type="text" id="m-dn-2" placeholder="No. DN Tambahan...">
                        </div>
                        <div>
                            <label style="color: #2563eb;">(+) Tambah Qty (Kg)</label>
                            <input type="number" id="m-qty-2" placeholder="0">
                        </div>
                    </div>

                     <div class="form-grid-mobile" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label>Jenis Armada</label>
                            <input type="text" id="m-truck-type" placeholder="Contoh: Tronton / Trailer">
                        </div>
                        <div>
                            <label>Nopol (Optional)</label>
                            <input type="text" id="m-nopol" placeholder="B xxxx XX">
                        </div>
                    </div>

                    <div style="text-align: right;">
                        <button class="btn btn-pro-save" onclick="saveManualPlanning()">
                            <i class="fa-solid fa-save"></i> SIMPAN MANUAL
                        </button>
                    </div>

                </div>
            </div>

            <div id="page-monitoring" class="page">
                <div class="stats-container">
                    <div class="stats-row row-3-cols">
                        <div class="stat-new-card st-plan">
                            <div class="st-icon-box"><i class="fa-solid fa-truck"></i></div>
                            <div class="st-content">
                                <h4>PLANNING DELIVERY</h4>
                                <p id="s-row1-planning">0</p>
                            </div>
                        </div>
                        <div class="stat-new-card st-self">
                            <div class="st-icon-box"><i class="fa-solid fa-people-carry-box"></i></div>
                            <div class="st-content">
                                <h4>AMBIL SENDIRI</h4>
                                <p id="s-row1-self">0</p>
                            </div>
                        </div>
                        <div class="stat-new-card st-total">
                            <div class="st-icon-box"><i class="fa-solid fa-list-check"></i></div>
                            <div class="st-content">
                                <h4>TOTAL PLANNING</h4>
                                <p id="s-row1-total">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="stats-row row-4-cols">
                        <div class="stat-new-card st-gate">
                            <div class="st-icon-box"><i class="fa-solid fa-check-circle"></i></div>
                            <div class="st-content">
                                <h4>GATE IN</h4>
                                <p id="s-row2-gatein">0</p>
                            </div>
                        </div>
                        <div class="stat-new-card st-pend">
                            <div class="st-icon-box"><i class="fa-solid fa-clock"></i></div>
                            <div class="st-content">
                                <h4>BELUM MASUK</h4>
                                <p id="s-row2-pending">0</p>
                            </div>
                        </div>
                        <div class="stat-new-card st-canc">
                            <div class="st-icon-box"><i class="fa-solid fa-ban"></i></div>
                            <div class="st-content">
                                <h4>CANCEL</h4>
                                <p id="s-row2-cancel">0</p>
                            </div>
                        </div>
                        <div class="stat-new-card st-tona">
                            <div class="st-icon-box"><i class="fa-solid fa-weight-hanging"></i></div>
                            <div class="st-content">
                                <h4>TONASE (KG)</h4>
                                <p id="s-row2-tonase">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="smart-filter-box">
                    <div class="sf-header">
                        <i class="fa-solid fa-filter"></i> FILTER
                    </div>
                    <div class="sf-grid">
                        <input type="text" id="sf-vendor" list="list-history-vendor" placeholder="Vendor..." onkeyup="updateMonitoring()">
                        <input type="text" id="sf-armada" placeholder="Armada / Truck..." onkeyup="updateMonitoring()">
                        <input type="text" id="sf-area" list="list-area-options" placeholder="Area..." onkeyup="updateMonitoring()">
                        <input type="text" id="sf-city" placeholder="Kota..." onkeyup="updateMonitoring()">
                        <input type="text" id="sf-customer" placeholder="Customer..." onkeyup="updateMonitoring()">
                        <input type="text" id="sf-catatan" list="list-history-catatan" placeholder="Catatan..." onkeyup="updateMonitoring()">
                        <select id="sf-outs" onchange="updateMonitoring()">
                            <option value=""> Pilih</option>
                            <option value="YES">Outstanding Only</option>
                            <option value="NO">Sesuai Jadwal</option>
                        </select>
                        <button class="btn btn-white" onclick="resetSmartFilters()">
                            <i class="fa-solid fa-rotate-left"></i> RESET
                        </button>
                    </div>
                </div>
                <div class="analysis-control-bar" style="justify-content: space-between;">
                    <div style="display:flex; gap:10px; flex: 1;">
                        <input type="text" id="monSearch" class="input-search" placeholder=" Cari..." onkeyup="updateMonitoring()" style="flex:1;">
                        <select id="filterStatus" onchange="updateMonitoring()" style="width: auto; min-width: 120px;">
                            <option value="">SEMUA STATUS</option>
                            <option value="Belum Masuk">BELUM MASUK</option>
                            <option value="Gate In">GATE IN</option>
                            <option value="Cancelled">CANCELLED</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <div style="background: #fff7ed; padding: 5px 10px; border:1px solid #fed7aa; border-radius: 6px; display:flex; gap:5px; align-items: center;">
                            <span style="font-size: 0.7rem; font-weight:700; color:#c2410c;">PINDAH TGL:</span>
                            <input type="date" id="bulk-move-date" style="padding: 2px 5px; width: 110px;">
                            <button class="btn btn-primary" onclick="processBulkMoveDate()" style="padding: 2px 8px; font-size: 0.7rem;">GO</button>
                        </div>
                        
                        <button class="btn btn-white" onclick="bulkRemoveNextDay()" title="Hapus kata 'Next Day' dari Catatan">
                            <i class="fa-solid fa-eraser"></i> HAPUS ND
                        </button>

                        <button class="btn btn-white" onclick="exportTableToImage()"><i class="fa-solid fa-camera"></i> IMG</button>
                        <button class="btn btn-pro-excel" onclick="exportToExcel()"><i class="fa-solid fa-file-excel"></i> XLS</button>
                        <button class="btn btn-pro-reset" onclick="bulkDeleteMonitoring()"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="main-data-table" id="dn-table-excel">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="check-all" onclick="toggleAllChecks()"></th>
                                <th>No</th>
                                <th>No DN</th>
                                <th>No SN</th>
                                <th>Plan Date</th>
                                <th>Vendor</th>
                                <th>Armada</th>
                                <th>Area</th>
                                <th>Kota</th>
                                <th>Customer</th>
                                <th>Qty (Kg)</th>
                                <th>Catatan</th>
                                <th>Outs</th>
                                <th>Status</th>
                                <th>Action</th>
                                <th>Edit</th>
                            </tr>
                        </thead>
                        <tbody id="monTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="page-analysis" class="page">
                <div class="analysis-control-bar">
    <div style="display: flex; align-items: center; gap: 10px;">
        <label style="margin:0; font-size: 0.8rem; font-weight: 700; color: #475569;">TANGGAL ANALISA:</label>
        <input type="date" id="analysis-date" onchange="updateAnalysis()" style="width: auto; font-weight: 600;">
    </div>

    <div class="stats-header-group">
        <div class="stat-mini box-blue" title="Plan Delivery Reguler (Non Next Day)">
            <div class="mini-icon"><i class="fa-solid fa-truck"></i></div>
            <div class="mini-content">
                <span class="mini-label">PLANNING</span>
                <span class="mini-value" id="box-plan-reg">0</span>
            </div>
        </div>

        <div class="stat-mini box-teal" title="Plan Cargo Next Day">
            <div class="mini-icon"><i class="fa-solid fa-clock"></i></div>
            <div class="mini-content">
                <span class="mini-label">NEXT DAY</span>
                <span class="mini-value" id="box-plan-nd">0</span>
            </div>
        </div>

        <div class="stat-mini box-green" title="Realisasi Total (Reguler + Next Day)">
            <div class="mini-icon"><i class="fa-solid fa-check-double"></i></div>
            <div class="mini-content">
                <span class="mini-label">REALISASI (FRANCO)</span>
                <span class="mini-value" id="box-act-total">0</span>
            </div>
        </div>

        <div class="stats-divider"></div>

        <div class="stat-mini box-orange" title="Plan Ambil Sendiri">
            <div class="mini-icon"><i class="fa-solid fa-people-carry-box"></i></div>
            <div class="mini-content">
                <span class="mini-label">AMBIL SENDIRI</span>
                <span class="mini-value" id="box-plan-self">0</span>
            </div>
        </div>

        <div class="stat-mini box-purple" title="Actual Ambil Sendiri">
            <div class="mini-icon"><i class="fa-solid fa-clipboard-check"></i></div>
            <div class="mini-content">
                <span class="mini-label">REALISASI (LOCO)</span>
                <span class="mini-value" id="box-act-self">0</span>
            </div>
        </div>
    </div>

    <button class="btn btn-pro-save" onclick="exportGapImage()">
        <i class="fa-solid fa-download"></i> UNDUH GAMBAR REKAP
    </button>
    <button class="btn" style="background-color: #25D366; color: white;" onclick="shareToWhatsApp(this)">
        <i class="fa-brands fa-whatsapp"></i> KIRIM KE WHATSAPP
    </button>
</div>

                <div id="exportAreaContainer" style="background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h2 style="font-size: 1.2rem; color: #1e293b; margin: 0 0 20px 0; border-left: 5px solid #2563eb; padding-left: 15px;">
                        DAILY LOGISTIC RECON <span id="analysis-date-display" style="font-weight: 400; color: #64748b; font-size: 0.9rem;"></span>
                    </h2>
                    
                    <div class="gap-container-flex">
                        <div class="gap-table-box theme-blue">
                            <div class="table-header-title"> PLAN DELIVERY </div>
                            <table class="analysis-table">
                                <thead><tr><th style="width:40%">AREA</th><th>PLAN</th><th>REALZ</th><th>GAP</th></tr></thead>
                                <tbody id="body-plan-today"></tbody>
                            </table>
                        </div>
                        <div class="gap-table-box theme-orange">
                            <div class="table-header-title"> CARGO NEXT DAY</div>
                            <table class="analysis-table">
                                <thead><tr><th style="width:40%">AREA</th><th>PLAN</th><th>REALZ</th><th>GAP</th></tr></thead>
                                <tbody id="body-next-day"></tbody>
                            </table>
                        </div>
                        <div class="gap-table-box theme-green">
                            <div class="table-header-title"> SUMMARY (TOTAL)</div>
                            <table class="analysis-table">
                                <thead><tr><th style="width:40%">AREA</th><th>PLAN</th><th>REALZ</th><th>GAP</th></tr></thead>
                                <tbody id="body-summary"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; border-top: 2px dashed #cbd5e1; padding-top: 20px;">
                        <div class="theme-dark" style="margin-bottom: 20px;">
                            <div class="table-header-title"> UNIT BREAKDOWN : PLAN & NEXT DAY</div>
                            <div class="table-responsive">
                                <table class="combined-table analysis-table" style="border-collapse: collapse; width: 100%; text-align: center; background-color: white;">
                                    <thead>
                                        <tr style="color: white;">
                                            <th rowspan="3" style="border: 1px solid #cbd5e1; background-color: #1e293b; width: 10%;">AREA</th>
                                            <th colspan="9" style="border: 1px solid #cbd5e1; background-color: #1e3a8a;">PLAN DELIVERY</th>
                                            <th colspan="9" style="border: 1px solid #cbd5e1; background-color: #ea580c;">CARGO NEXT DAY</th>
                                        </tr>
                                        <tr style="color: white;">
                                            <th colspan="3" style="border: 1px solid #cbd5e1; background-color: #2563eb;">TRONTON</th>
                                            <th colspan="3" style="border: 1px solid #cbd5e1; background-color: #2563eb;">TRAILER</th>
                                            <th colspan="3" style="border: 1px solid #cbd5e1; background-color: #2563eb;">CONTAINER</th>
                                            
                                            <th colspan="3" style="border: 1px solid #cbd5e1; background-color: #f59e0b;">TRONTON</th>
                                            <th colspan="3" style="border: 1px solid #cbd5e1; background-color: #f59e0b;">TRAILER</th>
                                            <th colspan="3" style="border: 1px solid #cbd5e1; background-color: #f59e0b;">CONTAINER</th>
                                        </tr>
                                        <tr style="background-color: #f8fafc; font-size: 0.75rem; font-weight: bold;">
                                            <th style="border: 1px solid #cbd5e1;">P</th><th style="border: 1px solid #cbd5e1;">R</th><th style="border: 1px solid #cbd5e1;">G</th>
                                            <th style="border: 1px solid #cbd5e1;">P</th><th style="border: 1px solid #cbd5e1;">R</th><th style="border: 1px solid #cbd5e1;">G</th>
                                            <th style="border: 1px solid #cbd5e1;">P</th><th style="border: 1px solid #cbd5e1;">R</th><th style="border: 1px solid #cbd5e1;">G</th>
                                            
                                            <th style="border: 1px solid #cbd5e1;">P</th><th style="border: 1px solid #cbd5e1;">R</th><th style="border: 1px solid #cbd5e1;">G</th>
                                            <th style="border: 1px solid #cbd5e1;">P</th><th style="border: 1px solid #cbd5e1;">R</th><th style="border: 1px solid #cbd5e1;">G</th>
                                            <th style="border: 1px solid #cbd5e1;">P</th><th style="border: 1px solid #cbd5e1;">R</th><th style="border: 1px solid #cbd5e1;">G</th>
                                        </tr>
                                    </thead>
                                    <tbody id="body-breakdown-integrated">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="theme-dark" style="width: 300px;">
                            <div class="table-header-title"> AMBIL SENDIRI </div>
                            <table class="analysis-table">
                                <tbody id="body-ambil-sendiri"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-history" class="page">
                <div class="history-card-container">
                    
                    <div class="history-header-title">
                        <i class="fa-solid fa-database"></i> Database History (Selesai/Gate In)
                    </div>

                    <div class="history-controls">
                        <div class="history-controls-left">
                            <div class="form-group" style="margin:0;">
                                <label style="margin-bottom:2px;">Dari Tanggal</label>
                                <input type="date" id="hist-start" style="padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 4px;">
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label style="margin-bottom:2px;">Sampai Tanggal</label>
                                <input type="date" id="hist-end" style="padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 4px;">
                            </div>
                            <button class="btn btn-primary" onclick="renderHistory()" style="height: 35px; border-radius: 4px;">
                                <i class="fa-solid fa-search"></i> CARI
                            </button>
                        </div>

                        <div class="history-controls-right">
                            <button class="btn btn-pro-reset" onclick="deleteSelectedHistory()" style="background-color: #ef4444; height: 35px; border-radius: 4px;">
                                <i class="fa-solid fa-trash-can"></i> HAPUS TERPILIH
                            </button>
                            <button class="btn btn-pro-excel" onclick="exportHistoryExcel()" style="background-color: #10b981; height: 35px; border-radius: 4px;">
                                <i class="fa-solid fa-file-export"></i> EXCEL
                            </button>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <input type="text" id="histSearch" class="input-search" placeholder="Cari data history (Global Search)..." onkeyup="renderHistory()" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                    </div>

                    <div class="table-responsive">
                        <table class="main-data-table" id="table-history-data" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" id="checkAllHistory" onclick="toggleAllHistory(this)"></th>
                                    <th>NO</th>
                                    <th>NO DN</th>
                                    <th>NO SN</th>
                                    <th>PLAN DATE</th>
                                    <th>VENDOR</th>
                                    <th>ARMADA</th>
                                    <th>AREA</th>
                                    <th>KOTA</th>
                                    <th>CUSTOMER</th>
                                    <th>QTY (KG)</th>
                                    <th>CATATAN</th>
                                    <th>OUTS</th>
                                    <th>GATE IN TIME</th>
                                </tr>
                            </thead>
                            <tbody id="histTableBody"></tbody>
                        </table>
                    </div>

                </div>
            </div>
            
            <div id="page-route" class="page"><div class="card"><h3> Route Planning Master</h3><p>Modul dalam pengembangan (Tersambung ke Firestore).</p></div></div>
            <div id="page-driver" class="page"><div class="card"><h3> Driver Master Data</h3><p>Modul dalam pengembangan (Tersambung ke Firestore).</p></div></div>
            <div id="page-vehicle" class="page"><div class="card"><h3> Vehicle Master Data</h3><p>Modul dalam pengembangan (Tersambung ke Firestore).</p></div></div>

            <footer>
                &copy; 2026 InDeCo System - Ahmad Fauzi IKK Logistic Dept.
            </footer>
        </div>
    </div>

    <div class="modal-overlay" id="editModalOverlay">
        <div class="modal-box">
            <div class="modal-header">
                <span style="font-weight: 700; color: #1e293b;"><i class="fa-solid fa-pen-to-square"></i> Edit Data Delivery</span>
                <button class="btn-action" style="float: right; color:#0d2e5c; background:none;" onclick="closeEditModal()"><i class="fa-solid fa-xmark" style="font-size:1.2rem;"></i></button>
            </div>
            <hr style="margin: 10px 0 20px 0; border:0; border-top:1px solid #e2e8f0;">
            <input type="hidden" id="edit-id">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom:15px;">
                <div><label>No DN</label><input type="text" id="edit-dn"></div>
                <div><label>No SN</label><input type="text" id="edit-sn"></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom:15px;">
                <div><label>Customer</label><input type="text" id="edit-customer"></div>
                <div><label>Kota</label><input type="text" id="edit-city"></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom:15px;">
                <div><label>Area</label><input type="text" id="edit-area" list="list-area-options"></div>
                <div><label>Qty (Kg)</label><input type="number" id="edit-qty"></div>
            </div>
            <div style="margin-bottom:15px;"><label>Transporter</label><input type="text" id="edit-vendor" list="list-history-vendor"></div>
            <div style="margin-bottom:15px;"><label>Armada / Nopol</label><input type="text" id="edit-truck"></div>
            <div style="margin-bottom:20px;"><label>Catatan</label><input type="text" id="edit-catatan" list="list-history-catatan"></div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-white" onclick="closeEditModal()">Batal</button>
                <button class="btn btn-primary" onclick="saveEditData()">Simpan Perubahan</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="statusModalOverlay">
        <div class="modal-box" style="width: 500px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 3rem; margin-bottom: 10px;"></div>
                <h3 style="margin:0;">Update Status Unit?</h3>
                <p style="color:#64748b; margin:5px 0;">Pilih status terbaru untuk unit ini.</p>
            </div>
            
            <input type="hidden" id="status-update-id">
            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.85rem; border: 1px solid #e2e8f0;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>No DN:</span> <strong id="st-dn">-</strong></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Vendor:</span> <strong id="st-vendor">-</strong></div>
                <div style="display:flex; justify-content:space-between;"><span>Cust:</span> <strong id="st-customer">-</strong></div>
            </div>

            <div class="status-buttons-container">
                <button class="btn-status-opt btn-opt-plan" onclick="executeStatusUpdate('Belum Masuk')">
                    <i class="fa-solid fa-calendar" style="font-size: 1.5rem;"></i>
                    BELUM MASUK
                </button>
                <button class="btn-status-opt btn-opt-gatein" onclick="executeStatusUpdate('Gate In')">
                    <i class="fa-solid fa-check-double" style="font-size: 1.5rem;"></i>
                    GATE IN
                </button>
                <button class="btn-status-opt btn-opt-cancel" onclick="executeStatusUpdate('Cancelled')">
                    <i class="fa-solid fa-ban" style="font-size: 1.5rem;"></i>
                    CANCEL
                </button>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <a href="#" onclick="closeStatusModal()" style="color:#94a3b8; font-size:0.8rem; text-decoration:none;">Batal, jangan ubah apa-apa</a>
            </div>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyCTK_50YcaSmtDyJAFDXqdg9cFLFaI9CYI",
          authDomain: "indeco-ikk-logistik.firebaseapp.com",
          projectId: "indeco-ikk-logistik",
          storageBucket: "indeco-ikk-logistik.firebasestorage.app",
          messagingSenderId: "918642172894",
          appId: "1:918642172894:web:3a9ee4dfee9b387c01f34f"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. GLOBAL VARIABLES ---
        let allShipments = []; 
        let snapshotUnsubscribe = null; 
        let myChartArea = null;
        let myChartArmada = null;
        let myChartCustomer = null;

        const KEY_LAST_PAGE = 'indeco_last_page';

        function formatNumber(num) { 
            return num ? num.toLocaleString('id-ID') : '0'; 
        }
        function toggleSidebar() {
            // Cek apakah layar kecil (Mobile)
            if (window.innerWidth <= 768) {
                // Logika Mobile: Tambah/Hapus class 'mobile-nav-active'
                document.body.classList.toggle('mobile-nav-active');
            } else {
                // Logika Desktop: Tambah/Hapus class 'sidebar-hidden' (Logic lama)
                document.body.classList.toggle('sidebar-hidden');
            }
        }

        // Tambahan: Tutup sidebar otomatis saat menu diklik (Khusus Mobile)
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    document.body.classList.remove('mobile-nav-active');
                }
            });
        });

        // --- 3. AUTHENTICATION ---
        auth.onAuthStateChanged((user) => {
            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');

            if (user) {
                console.log("Logged in as:", user.email);
                document.body.setAttribute('data-logged-in', 'true');
                loginPage.style.display = 'none';
                appContainer.classList.add('active');
                
                initRealtimeListener();
                initAppData();
            } else {
                console.log("Logged out");
                document.body.removeAttribute('data-logged-in');
                appContainer.classList.remove('active');
                loginPage.style.display = 'flex';
                loginPage.style.opacity = '1';
                
                if(snapshotUnsubscribe) snapshotUnsubscribe();
                allShipments = [];
            }
        });

        function attemptLogin() {
            const email = document.getElementById('login-username').value;
            const pass = document.getElementById('login-password').value;
            
            if(!email || !pass) { alert("Email dan Password tidak boleh kosong!"); return; }
            
            const btn = document.querySelector('.btn-login');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';
            btn.disabled = true;

            auth.signInWithEmailAndPassword(email, pass)
                .then(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                })
                .catch((error) => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    alert("Login Gagal: " + error.message);
                });
        }

        function confirmLogout() {
            if(confirm("Anda yakin ingin keluar dari sistem?")) {
                auth.signOut();
            }
        }

        // --- 4. FIRESTORE LISTENER ---
        function initRealtimeListener() {
            snapshotUnsubscribe = db.collection('monitoring')
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    const temp = [];
                    snapshot.forEach((doc) => {
                        temp.push({ id: doc.id, ...doc.data() });
                    });
                    
                    allShipments = temp;
                    console.log(`Updated: ${allShipments.length} records.`);
                    
                    updateMasterDataFromEntries();
                    refreshAllViews();
                }, (error) => {
                    console.error("Firestore Error:", error);
                });
        }

        function updateMasterDataFromEntries() {
            const vendors = [...new Set(allShipments.map(s => s.vendor))].filter(Boolean).sort();
            const notes = [...new Set(allShipments.map(s => s.catatan))].filter(Boolean).sort();
            
            const listVendor = document.getElementById('list-history-vendor');
            const listCatatan = document.getElementById('list-history-catatan');
            
            if(listVendor) listVendor.innerHTML = vendors.map(v => `<option value="${v}">`).join('');
            if(listCatatan) listCatatan.innerHTML = notes.map(n => `<option value="${n}">`).join('');
        }

        function refreshAllViews() {
            const dashboard = document.getElementById('page-dashboard');
            const monitoring = document.getElementById('page-monitoring');
            const analysis = document.getElementById('page-analysis');
            const history = document.getElementById('page-history');

            if (dashboard.classList.contains('active')) renderDashboard();
            if (monitoring.classList.contains('active')) updateMonitoring();
            if (analysis.classList.contains('active')) updateAnalysis();
            if (history.classList.contains('active')) renderHistory();
        }

        // --- 5. INITIALIZATION ---
        function initAppData() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('p-bulk-date');
            if(dateInput && !dateInput.value) dateInput.value = today;
            
            const mDateInput = document.getElementById('m-date');
            if(mDateInput && !mDateInput.value) mDateInput.value = today;
            
            const analysisInput = document.getElementById('analysis-date');
            if(analysisInput && !analysisInput.value) analysisInput.value = today;

            const lastPage = localStorage.getItem(KEY_LAST_PAGE) || 'dashboard';
            const menu = document.getElementById('menu-' + lastPage);
            const label = menu ? menu.getAttribute('data-tooltip') : 'Executive Dashboard';
            showPage(lastPage, label);
        }

        function showPage(pageId, label) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(m => m.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            
            const activeMenu = document.getElementById('menu-' + pageId);
            if(activeMenu) activeMenu.classList.add('active');
            
            if(label) document.getElementById('sub-page-title').innerText = label;
            localStorage.setItem(KEY_LAST_PAGE, pageId);
            
            if(pageId === 'dashboard') renderDashboard();
            if(pageId === 'monitoring') updateMonitoring();
            if(pageId === 'analysis') updateAnalysis();
            if(pageId === 'history') renderHistory();
        }

        // --- 6. DASHBOARD LOGIC (History Based) ---
        function renderDashboard() {
            let start = document.getElementById('dash-start').value;
            let end = document.getElementById('dash-end').value;
            
            const today = new Date();
            if (!start) { 
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                start = firstDay.toISOString().split('T')[0]; 
                document.getElementById('dash-start').value = start; 
            }
            if (!end) { 
                end = today.toISOString().split('T')[0]; 
                document.getElementById('dash-end').value = end; 
            }

            const filteredData = allShipments.filter(d => 
                d.status === 'Gate In' && 
                d.date >= start && 
                d.date <= end
            );

            if (filteredData.length === 0) {
                resetDashboardStats();
                return;
            }

            const vendors = new Set();
            let totalTonase = 0;
            let totalDN = filteredData.length;
            
            filteredData.forEach(d => {
                if(d.vendor && d.vendor !== "BELUM BOOKING") vendors.add(d.vendor.toUpperCase().trim());
                totalTonase += (d.qty || 0);
            });

            const activeVendors = vendors.size;
            const avgQty = totalDN > 0 ? (totalTonase / totalDN) : 0;

            document.getElementById('d-val-vendor').innerText = activeVendors;
            document.getElementById('d-val-tonase').innerText = formatNumber(Math.round(totalTonase));
            document.getElementById('d-val-dn').innerText = formatNumber(totalDN);
            document.getElementById('d-val-avg').innerText = formatNumber(Math.round(avgQty));

            const areaCounts = {}; 
            ["JABODETABEK", "JAWA TENGAH", "JAWA TIMUR", "LUAR PULAU", "AMBIL SENDIRI"].forEach(a => areaCounts[a] = 0);
            
            const armadaCounts = { 'Tronton': 0, 'Trailer': 0, 'Container': 0, 'Lainnya': 0 };
            const custMap = {};

            filteredData.forEach(d => {
                let areaKey = d.area || "Lainnya";
                if(areaCounts[areaKey] === undefined) areaCounts[areaKey] = 0;
                areaCounts[areaKey] += 1;

                const type = (d.truck || "").toLowerCase();
                if(type.includes('tronton')) armadaCounts['Tronton']++;
                else if(type.includes('trailer')) armadaCounts['Trailer']++;
                else if(type.includes('cont') || type.includes('20') || type.includes('40')) armadaCounts['Container']++;
                else armadaCounts['Lainnya']++;

                const cityName = d.city ? d.city : "Unknown";
                const customerName = d.customer ? d.customer : "Unknown"; 
                const key = `${customerName} (${cityName})`; 
                custMap[key] = (custMap[key] || 0) + 1; 
            });

            const sortedCust = Object.entries(custMap).sort((a, b) => b[1] - a[1]).slice(0, 5);
            renderCharts(areaCounts, armadaCounts, sortedCust);
        }

        function resetDashboardStats() {
            document.getElementById('d-val-vendor').innerText = "0";
            document.getElementById('d-val-tonase').innerText = "0";
            document.getElementById('d-val-dn').innerText = "0";
            document.getElementById('d-val-avg').innerText = "0";
            renderCharts({}, {}, []);
        }

        function renderCharts(areaData, armadaData, custData) {
            Chart.register(ChartDataLabels);
            if(myChartArea) myChartArea.destroy();
            if(myChartArmada) myChartArmada.destroy();
            if(myChartCustomer) myChartCustomer.destroy();

            const ctxArea = document.getElementById('chartArea').getContext('2d');
            myChartArea = new Chart(ctxArea, {
                type: 'bar',
                data: { 
                    labels: Object.keys(areaData), 
                    datasets: [{ label: 'Total DN', data: Object.values(areaData), backgroundColor: '#3b82f6', borderRadius: 6, barThickness: 40 }] 
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', color: '#1e293b', font: { weight: 'bold', size: 12 }, formatter: Math.round } }, 
                    layout: { padding: { top: 25 } }, 
                    scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' }, border: { display: false } }, x: { grid: { display: false } } } 
                }
            });

            const ctxArmada = document.getElementById('chartArmada').getContext('2d');
            myChartArmada = new Chart(ctxArmada, {
                type: 'doughnut',
                data: { 
                    labels: Object.keys(armadaData), 
                    datasets: [{ data: Object.values(armadaData), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#cbd5e1'], borderWidth: 2, borderColor: '#ffffff' }] 
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { position: 'right', labels: { boxWidth: 15, padding: 15, font: {size: 11} } }, datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (value) => { return value > 0 ? value : ''; } } },
                    cutout: '60%'
                }
            });

            const ctxCust = document.getElementById('chartCustomer').getContext('2d');
            myChartCustomer = new Chart(ctxCust, {
                type: 'bar',
                data: { 
                    labels: custData.map(item => item[0]), 
                    datasets: [{ label: 'Total DN', data: custData.map(item => item[1]), backgroundColor: '#2563eb', borderRadius: 5, barPercentage: 0.6 }] 
                },
                options: { 
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', color: '#1e293b', font: { weight: 'bold', size: 12 }, formatter: Math.round, offset: 4 } }, 
                    layout: { padding: { right: 40 } }, 
                    scales: { x: { beginAtZero: true, grid: { color: '#f1f5f9' }, border: { display: false } }, y: { ticks: { font: { size: 11, weight: '600' }, color: '#334155', autoSkip: false }, grid: { display: false }, border: { display: false } } } 
                }
            });
        }

        // --- 7. ANALYSIS LOGIC ---
        function updateAnalysis() {
            const selectedDateInput = document.getElementById('analysis-date').value;
            if(!selectedDateInput) return; 

        // /// MULAI SISIPAN: LOGIKA 5 BOX STATISTIK BARU (FRANCO vs LOCO) ///
        
        // Variabel Penampung
        let val_RegPlan = 0;   // Plan Reguler (Franco)
        let val_NextDay = 0;   // Plan Next Day (Franco)
        let val_RealFranco = 0; // Realisasi Gate In (Reguler + Next Day)
        
        let val_SelfPlan = 0;  // Plan Ambil Sendiri
        let val_SelfReal = 0;  // Realisasi Ambil Sendiri
        
        if(typeof allShipments !== 'undefined' && allShipments.length > 0) {
            allShipments.forEach(itm => {
                // 1. Filter Status Cancelled
                if(itm.status === 'Cancelled') return;
                
                // 2. Filter Harus Tanggal Terpilih
                if(itm.date !== selectedDateInput) return;

                // Ambil Data
                let qty = parseFloat(itm.qty || 0);
                let note = (itm.catatan || "").toUpperCase();
                let areaCheck = (itm.area || "").toUpperCase();
                let isGateIn = (itm.status === 'Gate In');
                
                // Cek Tipe: Ambil Sendiri (LOCO) atau Delivery (FRANCO)
                let isSelf = areaCheck.includes("AMBIL SENDIRI") || note.includes("AMBIL SENDIRI");
                let isNext = note.includes("NEXT DAY");

                if(isSelf) {
                    // --- LOGIKA LOCO ---
                    val_SelfPlan += qty;
                    if(isGateIn) val_SelfReal += qty;
                } else {
                    // --- LOGIKA FRANCO ---
                    
                    // Hitung Realisasi (Gabungan Reguler + Next Day)
                    if(isGateIn) val_RealFranco += qty;

                    // Hitung Planning (Dipisah: Reguler vs Next Day)
                    if(isNext) {
                        val_NextDay += qty;
                    } else {
                        val_RegPlan += qty;
                    }
                }
            });
        }

        // // --- FORMAT ANGKA (DIBAGI 1000 & DIBULATKAN) ---
        // const fmt = (n) => Math.round(n / 1000).toLocaleString('id-ID'); 

        // KODE BARU (Benar: Menampilkan nilai asli dalam Kg)
        // const fmt = (n) => Math.round(n).toLocaleString('id-ID');
        const fmt = (n) => Math.round(n / 1000).toLocaleString('id-ID');
        
        // Render ke HTML
        document.getElementById('box-plan-reg').innerText = fmt(val_RegPlan);
        document.getElementById('box-plan-nd').innerText = fmt(val_NextDay);
        document.getElementById('box-act-total').innerText = fmt(val_RealFranco);
        
        document.getElementById('box-plan-self').innerText = fmt(val_SelfPlan);
        document.getElementById('box-act-self').innerText = fmt(val_SelfReal);
        // /// AKHIR SISIPAN ///

            // Logic start
            const dateObj = new Date(selectedDateInput);
            document.getElementById('analysis-date-display').innerText = `(${dateObj.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }).toUpperCase()})`;

            const nextDateObj = new Date(selectedDateInput);
            nextDateObj.setDate(nextDateObj.getDate() + 1);
            const nextDateInput = nextDateObj.toISOString().split('T')[0];

            const areas = ["JABODETABEK", "JAWA TENGAH", "JAWA TIMUR", "LUAR PULAU"];
            const stats = {};
            const selfPickup = { pUnit: 0, rUnit: 0, pQty: 0, rQty: 0 }; 
            
            // Init Stats (Agar tabel selalu muncul meski data 0)
            areas.forEach(a => { stats[a] = { tP:0, tR:0, tQP:0, tQR:0, t_trP:0, t_trR:0, t_tlP:0, t_tlR:0, t_coP:0, t_coR:0, nP:0, nR:0, nQP:0, nQR:0, nt_trP:0, nt_trR:0, nt_tlP:0, nt_tlR:0, nt_coP:0, nt_coR:0 }; });

            if(allShipments && allShipments.length > 0) {
                allShipments.forEach(item => {
                    if(item.status === 'Cancelled') return;
                    
                    const area = item.area;
                    const qty = parseFloat(item.qty || 0);
                    const isRealz = (item.status === 'Gate In');
                    const t = (item.truck || "").toLowerCase();
                    
                    let isToday = (item.date === selectedDateInput);
                    let isNext = (item.date === nextDateInput);
                    let markedNextDay = (item.catatan && item.catatan.toUpperCase().includes("NEXT DAY"));

                    if(!isToday && !isNext) return;
                    
                    if (area === "AMBIL SENDIRI") {
                        if (isToday) { 
                            selfPickup.pUnit++; 
                            selfPickup.pQty += qty; 
                            if (isRealz) { selfPickup.rUnit++; selfPickup.rQty += qty; } 
                        }
                        return;
                    }
                    
                    if (stats[area]) {
                        if (isToday && !markedNextDay) {
                            stats[area].tP++; stats[area].tQP += qty;
                            if (isRealz) { stats[area].tR++; stats[area].tQR += qty; }
                            if (t.includes('tronton')) { stats[area].t_trP++; if(isRealz) stats[area].t_trR++; }
                            else if (t.includes('trailer')) { stats[area].t_tlP++; if(isRealz) stats[area].t_tlR++; }
                            else if (t.includes('cont') || t.includes('40') || t.includes('20')) { stats[area].t_coP++; if(isRealz) stats[area].t_coR++; }
                        }
                        else if ((isToday && markedNextDay) || isNext) {
                            stats[area].nP++; stats[area].nQP += qty;
                            if (isRealz) { stats[area].nR++; stats[area].nQR += qty; }
                            if (t.includes('tronton')) { stats[area].nt_trP++; if(isRealz) stats[area].nt_trR++; }
                            else if (t.includes('trailer')) { stats[area].nt_tlP++; if(isRealz) stats[area].nt_tlR++; }
                            else if (t.includes('cont') || t.includes('40') || t.includes('20')) { stats[area].nt_coP++; if(isRealz) stats[area].nt_coR++; }
                        }
                    }
                });
            }

            const b = (val) => `<span style="font-weight:800;">${val}</span>`;
            
            // Helper Render Rows
            const renderSimple = (id, mode) => {
                let sumP = 0, sumR = 0;
                let html = areas.map(a => {
                    let p, r;
                    if (mode === 'today') { p = stats[a].tP; r = stats[a].tR; }
                    else if (mode === 'next') { p = stats[a].nP; r = stats[a].nR; }
                    else { p = stats[a].tP + stats[a].nP; r = stats[a].tR + stats[a].nR; }
                    sumP += p; sumR += r;
                    let gap = p - r; let gapDisplay = gap > 0 ? `-${gap}` : gap; 
                    return `<tr><td style="text-align:left; padding-left:10px; font-weight:700;">${a}</td><td>${b(p)}</td><td>${b(r)}</td><td class="${gap > 0 ? 'gap-alert' : 'gap-safe'}">${b(gapDisplay)}</td></tr>`;
                }).join('');
                let totalGap = sumP - sumR; let totalGapDisplay = totalGap > 0 ? `-${totalGap}` : totalGap;
                html += `<tr class="row-total" style="background:#f1f5f9; border-top:2px solid #cbd5e1;"><td>TOTAL</td><td>${b(sumP)}</td><td>${b(sumR)}</td><td class="${totalGap > 0 ? 'gap-alert' : 'gap-safe'}">${b(totalGapDisplay)}</td></tr>`;
                document.getElementById(id).innerHTML = html;
            };
            
            renderSimple('body-plan-today', 'today'); 
            renderSimple('body-next-day', 'next'); 
            renderSimple('body-summary', 'summary');

            // Helper Render Breakdowns
            const renderIntegratedBreakdown = (targetId) => {
                let gt = {
                    tTrP:0, tTrR:0, tTlP:0, tTlR:0, tCoP:0, tCoR:0,
                    nTrP:0, nTrR:0, nTlP:0, nTlR:0, nCoP:0, nCoR:0
                };

                let html = areas.map(a => {
                    const d = {
                        tTrP: stats[a].t_trP || 0, tTrR: stats[a].t_trR || 0,
                        tTlP: stats[a].t_tlP || 0, tTlR: stats[a].t_tlR || 0,
                        tCoP: stats[a].t_coP || 0, tCoR: stats[a].t_coR || 0,
                        nTrP: stats[a].nt_trP || 0, nTrR: stats[a].nt_trR || 0,
                        nTlP: stats[a].nt_tlP || 0, nTlR: stats[a].nt_tlR || 0,
                        nCoP: stats[a].nt_coP || 0, nCoR: stats[a].nt_coR || 0
                    };

                    Object.keys(gt).forEach(key => gt[key] += d[key]);

                    const getGapStyle = (p, r) => {
                        const gap = p - r;
                        const bg = gap > 0 ? 'background-color: #fee2e2;' : 'background-color: #f0fdf4;';
                        const val = gap > 0 ? `-${gap}` : gap;
                        return `style="border: 1px solid #cbd5e1; color: #1e293b; font-weight: bold; ${bg}" data-val="${val}"`;
                    };

                    const renderGap = (p, r) => { const gap = p - r; return gap > 0 ? `-${gap}` : gap; };

                    return `
                        <tr style="background-color: white;">
                            <td style="text-align:left; padding-left:10px; font-weight:700; border: 1px solid #cbd5e1;">${a}</td>
                            <td style="border: 1px solid #cbd5e1;">${d.tTrP}</td><td style="border: 1px solid #cbd5e1; font-weight:bold;">${d.tTrR}</td><td ${getGapStyle(d.tTrP, d.tTrR)}>${renderGap(d.tTrP, d.tTrR)}</td>
                            <td style="border: 1px solid #cbd5e1;">${d.tTlP}</td><td style="border: 1px solid #cbd5e1; font-weight:bold;">${d.tTlR}</td><td ${getGapStyle(d.tTlP, d.tTlR)}>${renderGap(d.tTlP, d.tTlR)}</td>
                            <td style="border: 1px solid #cbd5e1;">${d.tCoP}</td><td style="border: 1px solid #cbd5e1; font-weight:bold;">${d.tCoR}</td><td ${getGapStyle(d.tCoP, d.tCoR)}>${renderGap(d.tCoP, d.tCoR)}</td>
                            
                            <td style="border: 1px solid #cbd5e1;">${d.nTrP}</td><td style="border: 1px solid #cbd5e1; font-weight:bold;">${d.nTrR}</td><td ${getGapStyle(d.nTrP, d.nTrR)}>${renderGap(d.nTrP, d.nTrR)}</td>
                            <td style="border: 1px solid #cbd5e1;">${d.nTlP}</td><td style="border: 1px solid #cbd5e1; font-weight:bold;">${d.nTlR}</td><td ${getGapStyle(d.nTlP, d.nTlR)}>${renderGap(d.nTlP, d.nTlR)}</td>
                            <td style="border: 1px solid #cbd5e1;">${d.nCoP}</td><td style="border: 1px solid #cbd5e1; font-weight:bold;">${d.nCoR}</td><td ${getGapStyle(d.nCoP, d.nCoR)}>${renderGap(d.nCoP, d.nCoR)}</td>
                        </tr>`;
                }).join('');

                const createGapTotal = (p, r) => {
                    const gap = p - r;
                    const bg = gap > 0 ? 'background-color: #fca5a5;' : 'background-color: #86efac;';
                    const val = gap > 0 ? `-${gap}` : gap;
                    return `<td style="border: 1px solid #475569; color: black; font-weight: 900; ${bg}">${val}</td>`;
                };

                html += `
                    <tr style="background-color: #f1f5f9; font-weight: 800;">
                        <td style="border: 1px solid #475569; text-align: center;">GRAND TOTAL</td>
                        
                        <td style="border: 1px solid #475569;">${gt.tTrP}</td><td style="border: 1px solid #475569;">${gt.tTrR}</td>${createGapTotal(gt.tTrP, gt.tTrR)}
                        <td style="border: 1px solid #475569;">${gt.tTlP}</td><td style="border: 1px solid #475569;">${gt.tTlR}</td>${createGapTotal(gt.tTlP, gt.tTlR)}
                        <td style="border: 1px solid #475569;">${gt.tCoP}</td><td style="border: 1px solid #475569;">${gt.tCoR}</td>${createGapTotal(gt.tCoP, gt.tCoR)}
                        
                        <td style="border: 1px solid #475569;">${gt.nTrP}</td><td style="border: 1px solid #475569;">${gt.nTrR}</td>${createGapTotal(gt.nTrP, gt.nTrR)}
                        <td style="border: 1px solid #475569;">${gt.nTlP}</td><td style="border: 1px solid #475569;">${gt.nTlR}</td>${createGapTotal(gt.nTlP, gt.nTlR)}
                        <td style="border: 1px solid #475569;">${gt.nCoP}</td><td style="border: 1px solid #475569;">${gt.nCoR}</td>${createGapTotal(gt.nCoP, gt.nCoR)}
                    </tr>`;

                document.getElementById(targetId).innerHTML = html;
            };

            renderIntegratedBreakdown('body-breakdown-integrated');

            let gapUnit = selfPickup.pUnit - selfPickup.rUnit;
            document.getElementById('body-ambil-sendiri').innerHTML = `<tr><th style="width:40%;">PRODUK</th><th>PLAN</th><th>REALISASI</th><th>GAP</th></tr><tr><td style="text-align:left; padding-left:10px; font-weight:bold;">BROWN</td><td>${b(selfPickup.pUnit)}</td><td style="font-weight:bold;">${b(selfPickup.rUnit)}</td><td class="${gapUnit > 0 ? 'gap-alert' : 'gap-safe'}">${b(gapUnit > 0 ? `-${gapUnit}` : gapUnit)}</td></tr>`;
        }

        // --- 8. PLANNING FUNCTIONS ---
        async function processBulkPlanning() {
            const rawData = document.getElementById('p-bulk-data').value.trim();
            let vendorName = document.getElementById('p-bulk-vendor').value.trim() || "BELUM BOOKING";
            let selectedArea = document.getElementById('p-bulk-area').value.trim() || "-";
            const manualDate = document.getElementById('p-bulk-date').value;
            const manualNote = document.getElementById('p-bulk-catatan').value; 

            if(!manualDate) { alert("MOHON ISI TANGGAL PICKUP!"); return; }
            if (!rawData) { alert("Mohon Paste data dari Excel!"); return; }
            if (!confirm("APAKAH ANDA YAKIN AKAN MEMBUAT PLANNING DELIVERY INI?")) { return; }

            const rows = rawData.split('\n');
            const groups = {};

            rows.forEach(row => {
                const cols = row.split('\t');
                if (cols.length < 5) return;
                
                const dnNumber = cols[1] ? cols[1].trim() : "";
                const snNumber = cols[3] ? cols[3].trim() : "";
                const customer = cols[4] ? cols[4].trim() : "";
                let rawCity = (cols[5] || "").toUpperCase().replace(/KABUPATEN|KAB\.|KOTA|ADMINISTRASI/gi, "").trim();
                const city = rawCity.split(" ")[0]; 
                const qty = parseFloat((cols[6] || "0").replace(/,/g, "")) || 0;

                const rawArmada = cols[8] ? cols[8].toUpperCase() : "";
                let armadaType = "Lainnya";
                if(rawArmada.includes("TRONTON")) armadaType = "TRONTON";
                else if(rawArmada.includes("TRAILER")) armadaType = "TRAILER";
                else if(rawArmada.includes("CDD") || rawArmada.includes("COLT")) armadaType = "CDD";
                else if(rawArmada.includes("FUSO")) armadaType = "FUSO";
                else if(rawArmada.includes("WING") || rawArmada.includes("BOX")) armadaType = "WINGBOX";
                else if(rawArmada.includes("CONT") || rawArmada.includes("20") || rawArmada.includes("40")) armadaType = "CONTAINER";
                else if(rawArmada.length > 2) armadaType = rawArmada; 

                const note1 = cols[7] ? cols[7].trim() : "";
                let fullNoteText = (note1 + " " + manualNote).toUpperCase();
                
                let isSelfPickup = fullNoteText.includes("AMBIL SENDIRI");
                let isNextDay = fullNoteText.includes("NEXT DAY");

                let finalNote = manualNote;
                let finalArea = selectedArea;

                if (isSelfPickup) { 
                    finalNote = "AMBIL SENDIRI"; 
                    finalArea = "AMBIL SENDIRI"; 
                } else if (isNextDay) {
                    finalNote = "NEXT DAY";
                }

                const gbMatch = note1.match(/GB\s*(\d+)/i);
                let groupKey = gbMatch ? `GB${gbMatch[1]}_${customer.replace(/\s+/g, '').toUpperCase()}_${snNumber}` : `S_${Date.now()}_${Math.random()}`;

                if (!groups[groupKey]) {
                    groups[groupKey] = {
                        dns: dnNumber, sn: snNumber, date: manualDate,
                        vendor: vendorName, truck: armadaType, area: finalArea, city: city, customer: customer,
                        qty: qty, catatan: finalNote, status: "Belum Masuk", gateInTime: null,
                        createdAt: new Date().toISOString()
                    };
                } else {
                    if (!groups[groupKey].dns.includes(dnNumber)) groups[groupKey].dns += `, ${dnNumber}`;
                    groups[groupKey].qty += qty;
                }
            });

            const batch = db.batch();
            let count = 0;
            const items = Object.values(groups);
            
            if(items.length > 450) { alert("Data terlalu banyak untuk satu batch. Mohon input bertahap (<450 baris)."); return; }

            items.forEach(item => {
                const docRef = db.collection("monitoring").doc();
                batch.set(docRef, item);
                count++;
            });

            try {
                await batch.commit();
                alert(`Berhasil menyimpan ${count} data planning!`);
                document.getElementById('p-bulk-data').value = "";
                showPage('monitoring', 'Live Monitoring');
            } catch (err) {
                console.error("Batch Failed:", err);
                alert("Gagal menyimpan data.");
            }
        }

        async function saveManualPlanning() {
            const date = document.getElementById('m-date').value;
            const vendor = document.getElementById('m-vendor').value.trim() || "BELUM BOOKING";
            const area = document.getElementById('m-area').value.trim() || "-";
            const dn1 = document.getElementById('m-dn').value.trim();
            const dn2 = document.getElementById('m-dn-2').value.trim();
            const sn = document.getElementById('m-sn').value.trim();
            const customer = document.getElementById('m-customer').value.trim() || "Unknown";
            const city = document.getElementById('m-city').value.trim() || "-";
            const rawQty1 = document.getElementById('m-qty').value;
            const rawQty2 = document.getElementById('m-qty-2').value;
            
            const parseSafeQty = (val) => {
                if(!val) return 0;
                return parseFloat(String(val).replace(/,/g, "")) || 0;
            };

            const totalQty = parseSafeQty(rawQty1) + parseSafeQty(rawQty2);
            const catatan = document.getElementById('m-catatan').value.trim();
            const truckType = document.getElementById('m-truck-type').value.trim().toUpperCase() || "-";
            const truckNopol = document.getElementById('m-nopol').value.trim().toUpperCase();
            
            if (!date) { alert("Tanggal Pickup wajib diisi!"); return; }
            if (!dn1) { alert("Nomor DN Utama wajib diisi!"); return; }

            let finalDN = dn1;
            if (dn2) finalDN += `, ${dn2}`;
            let finalTruck = truckType;
            if(truckNopol) finalTruck += ` ${truckNopol}`;

            const newItem = {
                dns: finalDN, sn: sn, date: date, vendor: vendor, truck: finalTruck,
                area: area, city: city, customer: customer, qty: totalQty,
                catatan: catatan, status: "Belum Masuk", gateInTime: null,
                originalDate: null, createdAt: new Date().toISOString()
            };

            try {
                await db.collection("monitoring").add(newItem);
                
                document.getElementById('m-dn').value = "";
                document.getElementById('m-dn-2').value = "";
                document.getElementById('m-sn').value = "";
                document.getElementById('m-customer').value = "";
                document.getElementById('m-city').value = "";
                document.getElementById('m-qty').value = "";
                document.getElementById('m-qty-2').value = "";
                document.getElementById('m-catatan').value = "";
                document.getElementById('m-nopol').value = "";

                alert("Data Planning Manual Berhasil Disimpan!");
                showPage('monitoring', 'Live Monitoring');
            } catch (err) {
                console.error(err);
                alert("Gagal menyimpan data.");
            }
        }

        // --- 9. MONITORING FUNCTIONS ---
        function updateMonitoring() {
            // -- ORIGINAL FILTERS --
            const q = document.getElementById('monSearch').value.toLowerCase();
            const filterVal = document.getElementById('filterStatus').value;

            // -- NEW SMART FILTERS (sf-) --
            const sfVendor = document.getElementById('sf-vendor').value.toLowerCase();
            const sfArmada = document.getElementById('sf-armada').value.toLowerCase();
            const sfArea = document.getElementById('sf-area').value.toLowerCase();
            const sfCity = document.getElementById('sf-city').value.toLowerCase();
            const sfCustomer = document.getElementById('sf-customer').value.toLowerCase();
            const sfCatatan = document.getElementById('sf-catatan').value.toLowerCase();
            const sfOuts = document.getElementById('sf-outs').value;

            // Variables for the NEW Statistics
            let countTotalJobs = 0; // Total Planning (All)
            let countRegularPlanning = 0; // Planning (Excl Ambil Sendiri)
            let countSelfPickup = 0; // Ambil Sendiri
            
            let countGateIn = 0;
            let countPending = 0;
            let countCancel = 0;
            let totalTonase = 0;

            const filteredForTable = allShipments.filter(item => {
                if (item.archived) return false;

                // 1. Search Bar Logic
                const allValues = Object.values(item).join(' ').toLowerCase();
                const matchesSearch = allValues.includes(q);

                // 2. Status Dropdown Logic
                let matchesStatus = true; 
                if (filterVal !== "") {
                    if (filterVal === 'Belum Masuk') matchesStatus = (item.status === 'Belum Masuk' || item.status === 'Planning');
                    else matchesStatus = (item.status === filterVal);
                }

                // 3. Smart Filter Logics (AND Condition)
                // Vendor
                const matchVendor = !sfVendor || (item.vendor || "").toLowerCase().includes(sfVendor);
                // Armada
                const matchArmada = !sfArmada || (item.truck || "").toLowerCase().includes(sfArmada);
                // Area
                const matchArea = !sfArea || (item.area || "").toLowerCase().includes(sfArea);
                // City
                const matchCity = !sfCity || (item.city || "").toLowerCase().includes(sfCity);
                // Customer
                const matchCustomer = !sfCustomer || (item.customer || "").toLowerCase().includes(sfCustomer);
                // Catatan
                const matchCatatan = !sfCatatan || (item.catatan || "").toLowerCase().includes(sfCatatan);
                
                // Outs Logic
                let matchOuts = true;
                if (sfOuts === 'YES') {
                    // Hanya tampilkan yang Outstanding (Original Date ada dan beda dengan Current Date)
                    matchOuts = (item.originalDate && item.originalDate !== item.date);
                } else if (sfOuts === 'NO') {
                    // Hanya tampilkan yang TIDAK Outstanding
                    matchOuts = (!item.originalDate || item.originalDate === item.date);
                }

                // Combine All
                return matchesSearch && matchesStatus && matchVendor && matchArmada && matchArea && matchCity && matchCustomer && matchCatatan && matchOuts;
            });

            filteredForTable.forEach(item => {
                countTotalJobs++;
                
                // --- 1. Stat Logic: Row 1 (Planning Breakdown) ---
                let isSelfPickup = (item.catatan || "").toUpperCase().includes("AMBIL SENDIRI");
                
                if (isSelfPickup) {
                    countSelfPickup++;
                } else {
                    countRegularPlanning++;
                }

                // --- 2. Stat Logic: Row 2 (Status Breakdown) ---
                if (item.status === 'Gate In') countGateIn++;
                if (item.status === 'Belum Masuk' || item.status === 'Planning') countPending++;
                if (item.status === 'Cancelled') countCancel++;
                
                // --- 3. Stat Logic: Tonase (Excl Cancelled) ---
                if (item.status !== 'Cancelled') totalTonase += parseFloat(item.qty || 0);
            });

            // Update DOM Elements for Statistics
            document.getElementById('s-row1-planning').innerText = countRegularPlanning;
            document.getElementById('s-row1-self').innerText = countSelfPickup;
            document.getElementById('s-row1-total').innerText = countTotalJobs;

            document.getElementById('s-row2-gatein').innerText = countGateIn;
            document.getElementById('s-row2-pending').innerText = countPending;
            document.getElementById('s-row2-cancel').innerText = countCancel;
            document.getElementById('s-row2-tonase').innerText = formatNumber(Math.round(totalTonase));

            // Render Table
            const tableBody = document.getElementById('monTableBody');

            if (filteredForTable.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="16" style="padding: 40px; text-align: center; color: #94a3b8;"><i class="fa-solid fa-clipboard-list" style="font-size:3rem; margin-bottom:10px;"></i><br>BELUM ADA DATA / TIDAK DITEMUKAN</td></tr>`;
                return;
            }

            tableBody.innerHTML = filteredForTable.map((item, idx) => {
                let statusClass = 'status-planning'; 
                if (item.status === 'Gate In') statusClass = 'status-gatein'; 
                else if (item.status === 'Cancelled') statusClass = 'status-cancelled'; 

                let statusLabel = item.status === 'Cancelled' ? 'CANCEL' : item.status;
                let vendorDisplay = item.vendor === "BELUM BOOKING" ? `<span style="color:#ef4444; font-weight:700;">BELUM BOOKING</span>` : item.vendor;
                
                let outstandingDesc = '-';
                if (item.originalDate && item.originalDate !== item.date) {
                    outstandingDesc = `<span class="text-outstanding">Outstanding ${item.originalDate}</span>`;
                }

                return `
                <tr>
                    <td><input type="checkbox" class="row-check" value="${item.id}" style="cursor:pointer;"></td>
                    <td>${idx + 1}</td>
                    <td style="font-weight:600;">${item.dns}</td>
                    <td>${item.sn || '-'}</td>
                    <td>${item.date}</td>
                    <td>${vendorDisplay}</td>
                    <td>${item.truck}</td>
                    <td>${item.area}</td>
                    <td>${item.city}</td>
                    <td>${item.customer}</td>
                    <td class="col-number">${formatNumber(Math.round(item.qty))}</td>
                    <td style="font-weight:600; color:#d97706;">${item.catatan || '-'}</td>
                    <td>${outstandingDesc}</td>
                    <td><span class="status-pill ${statusClass}">${statusLabel}</span></td>
                    <td><button class="btn-status-trigger btn btn-white" onclick="openStatusModal('${item.id}')">UPDATE STATUS</button></td>
                    <td><button class="btn-action btn-edit" onclick="editItem('${item.id}')"><i class="fa-solid fa-pen"></i></button></td>
                </tr>`;
            }).join('');
        }

        function resetSmartFilters() {
            document.getElementById('sf-vendor').value = "";
            document.getElementById('sf-armada').value = "";
            document.getElementById('sf-area').value = "";
            document.getElementById('sf-city').value = "";
            document.getElementById('sf-customer').value = "";
            document.getElementById('sf-catatan').value = "";
            document.getElementById('sf-outs').value = "";
            updateMonitoring();
        }

        // --- 10. HISTORY FUNCTIONS ---
        function renderHistory() {
            const q = document.getElementById('histSearch').value.toLowerCase();
            const start = document.getElementById('hist-start').value;
            const end = document.getElementById('hist-end').value;
            
            const filtered = allShipments.filter(d => {
                const isFinished = (d.status === 'Gate In' || d.status === 'Cancelled');
                if(!isFinished) return false;

                const allValues = Object.values(d).join(' ').toLowerCase();
                const matchesSearch = allValues.includes(q);
                let inRange = true;
                if (start && end) inRange = d.date >= start && d.date <= end;
                return matchesSearch && inRange;
            });
            
            const tbody = document.getElementById('histTableBody');
            
            const checkAll = document.getElementById('checkAllHistory');
            if(checkAll) checkAll.checked = false;

            if(filtered.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="14" style="padding:20px; color:#64748b; font-style:italic; text-align:center;">Tidak ada data history pada periode ini.</td></tr>'; 
                return; 
            }
            
            tbody.innerHTML = filtered.map((item, index) => {
                let outstandingDesc = '-';
                if (item.originalDate && item.originalDate !== item.date) {
                    outstandingDesc = `<span class="text-outstanding">Outstanding dari<br>${item.originalDate}</span>`;
                }
                
                return `
                <tr>
                    <td><input type="checkbox" class="hist-check" value="${item.id}"></td>
                    <td>${index + 1}</td>
                    <td style="font-weight:bold; color:#2563eb;">${item.dns}</td>
                    <td>${item.sn || '-'}</td>
                    <td>${item.date}</td>
                    <td>${item.vendor}</td>
                    <td>${item.truck || '-'}</td>
                    <td>${item.area}</td>
                    <td>${item.city}</td>
                    <td>${item.customer}</td>
                    <td class="col-number">${formatNumber(item.qty)}</td>
                    <td style="color:#d97706; font-weight:600;">${item.catatan || '-'}</td>
                    <td>${outstandingDesc}</td>
                    <td style="color:#0f172a; font-weight:600;">${item.gateInTime || '-'}</td>
                </tr>`;
            }).join('');
        }

        function toggleAllHistory(source) {
            const checkboxes = document.querySelectorAll('.hist-check');
            checkboxes.forEach(c => c.checked = source.checked);
        }

        async function deleteSelectedHistory() {
            const selected = document.querySelectorAll('.hist-check:checked');
            if (selected.length === 0) {
                alert("Pilih data yang akan dihapus terlebih dahulu!");
                return;
            }

            if (!confirm(`Apakah Anda yakin ingin menghapus ${selected.length} data terpilih secara permanen dari database?`)) {
                return;
            }

            const batch = db.batch();
            selected.forEach(cb => {
                const docRef = db.collection("monitoring").doc(cb.value);
                batch.delete(docRef);
            });

            try {
                await batch.commit();
                alert("Data berhasil dihapus!");
                renderHistory(); 
            } catch (err) {
                console.error("Delete Failed:", err);
                alert("Gagal menghapus data.");
            }
        }

        function exportHistoryExcel() {
            const table = document.getElementById('table-history-data');
            const clone = table.cloneNode(true);
            const qtyCells = clone.querySelectorAll('td:nth-child(10)');
            qtyCells.forEach(cell => { cell.style.fontWeight = "bold"; cell.style.textAlign = "right"; });
            
            const html = clone.outerHTML;
            const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
            const link = document.createElement('a');
            link.download = `HISTORY_${document.getElementById('hist-start').value || 'ALL'}_sd_${document.getElementById('hist-end').value || 'ALL'}.xls`;
            link.href = url; link.click();
        }

        // --- 11. ACTIONS & BULK DELETE LOGIC ---
        function toggleAllChecks() {
            const masterCheck = document.getElementById('check-all');
            const rowChecks = document.querySelectorAll('.row-check');
            rowChecks.forEach(cb => cb.checked = masterCheck.checked);
        }

        async function processBulkMoveDate() {
            const newDate = document.getElementById('bulk-move-date').value;
            if (!newDate) { alert("Pilih tanggal baru terlebih dahulu!"); return; }
            
            const checkedBoxes = document.querySelectorAll('.row-check:checked');
            if (checkedBoxes.length === 0) { alert("Pilih minimal satu data!"); return; }
            if (!confirm(`Yakin pindah ${checkedBoxes.length} data ke tanggal ${newDate}?`)) return;

            const batch = db.batch();
            checkedBoxes.forEach(cb => {
                const docId = cb.value;
                const item = allShipments.find(d => d.id === docId);
                if(item) {
                    const ref = db.collection("monitoring").doc(docId);
                    const updateData = { date: newDate };
                    if(!item.originalDate) updateData.originalDate = item.date;
                    batch.update(ref, updateData);
                }
            });

            try {
                await batch.commit();
                alert("Data berhasil dipindah!");
                document.getElementById('check-all').checked = false;
            } catch (err) {
                alert("Gagal update data: " + err.message);
            }
        }

        // --- BULK REMOVE 'NEXT DAY' ---
        async function bulkRemoveNextDay() {
            const checkedBoxes = document.querySelectorAll('.row-check:checked');
            if (checkedBoxes.length === 0) { alert("Pilih data yang akan dibersihkan catatannya!"); return; }

            if (!confirm(`Hapus kata 'NEXT DAY' dari catatan ${checkedBoxes.length} data terpilih?`)) return;

            const batch = db.batch();
            let count = 0;

            checkedBoxes.forEach(cb => {
                const docId = cb.value;
                const item = allShipments.find(d => d.id === docId);

                if (item && item.catatan) {
                    let newNote = item.catatan.replace(/NEXT DAY/gi, "").trim();
                    newNote = newNote.replace(/\s\s+/g, ' ');

                    if (newNote !== item.catatan) {
                        const ref = db.collection("monitoring").doc(docId);
                        batch.update(ref, { catatan: newNote });
                        count++;
                    }
                }
            });

            if (count === 0) {
                alert("Tidak ditemukan kata 'Next Day' pada data yang dipilih.");
                return;
            }

            try {
                await batch.commit();
                alert(`Berhasil menghapus kata 'NEXT DAY' dari ${count} data.`);
                document.getElementById('check-all').checked = false;
            } catch (err) {
                console.error("Error removing tag:", err);
                alert("Gagal update data: " + err.message);
            }
        }
        
        async function bulkDeleteMonitoring() {
            const checkedBoxes = document.querySelectorAll('.row-check:checked');
            if (checkedBoxes.length === 0) { alert("Pilih data yang akan dihapus."); return; }
            
            if (!confirm(`PERINGATAN: Anda akan menghapus ${checkedBoxes.length} data dari tampilan Monitoring. Lanjutkan?`)) return;

            const batch = db.batch();
            let archivedCount = 0;
            let deletedCount = 0;

            checkedBoxes.forEach(cb => {
                const docId = cb.value;
                const item = allShipments.find(d => d.id === docId);
                const ref = db.collection("monitoring").doc(docId);
                
                if (item && item.status === 'Gate In') {
                    batch.update(ref, { archived: true });
                    archivedCount++;
                } else {
                    batch.delete(ref);
                    deletedCount++;
                }
            });

            try {
                await batch.commit();
                let msg = "Proses Selesai.";
                if(archivedCount > 0) msg += `\n- ${archivedCount} Data 'Gate In' disimpan ke History (Hilang dari Monitoring).`;
                if(deletedCount > 0) msg += `\n- ${deletedCount} Data dihapus permanen.`;
                alert(msg);
                document.getElementById('check-all').checked = false;
            } catch(err) {
                alert("Gagal hapus data: " + err.message);
            }
        }

        function openStatusModal(id) {
            let item = allShipments.find(d => d.id === id); 
            if(!item) return;
            document.getElementById('status-update-id').value = item.id;
            document.getElementById('st-dn').innerText = item.dns;
            document.getElementById('st-vendor').innerText = item.vendor;
            document.getElementById('st-customer').innerText = `${item.customer} - ${item.city}`;
            document.getElementById('statusModalOverlay').classList.add('active');
        }
        function closeStatusModal() { document.getElementById('statusModalOverlay').classList.remove('active'); }
        
        function executeStatusUpdate(newStatus) { 
            const id = document.getElementById('status-update-id').value;
            const item = allShipments.find(d => d.id === id);
            
            let updates = { status: newStatus };
            if (newStatus === 'Gate In' && item.status !== 'Gate In') {
                const now = new Date();
                updates.gateInTime = now.toLocaleString('id-ID', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/\./g, ':');
            } else if (newStatus !== 'Gate In') {
                updates.gateInTime = null;
            }

            db.collection("monitoring").doc(id).update(updates)
                .then(() => { closeStatusModal(); })
                .catch(err => alert("Gagal update status: " + err.message));
        }

        function editItem(id) {
            let item = allShipments.find(d => d.id === id);
            if (!item) return;
            document.getElementById('edit-id').value = item.id;
            document.getElementById('edit-dn').value = item.dns;
            document.getElementById('edit-sn').value = item.sn || ""; 
            document.getElementById('edit-customer').value = item.customer;
            document.getElementById('edit-city').value = item.city;
            document.getElementById('edit-area').value = item.area;
            document.getElementById('edit-vendor').value = item.vendor;
            document.getElementById('edit-truck').value = item.truck;
            document.getElementById('edit-qty').value = item.qty;
            document.getElementById('edit-catatan').value = item.catatan || ''; 
            document.getElementById('editModalOverlay').classList.add('active');
        }
        function closeEditModal() { document.getElementById('editModalOverlay').classList.remove('active'); }
        
        function saveEditData() {
            const id = document.getElementById('edit-id').value;
            const updates = {
                dns: document.getElementById('edit-dn').value,
                sn: document.getElementById('edit-sn').value,
                customer: document.getElementById('edit-customer').value,
                city: document.getElementById('edit-city').value,
                area: document.getElementById('edit-area').value,
                vendor: document.getElementById('edit-vendor').value,
                truck: document.getElementById('edit-truck').value,
                qty: parseFloat(document.getElementById('edit-qty').value || 0),
                catatan: document.getElementById('edit-catatan').value
            };

            db.collection("monitoring").doc(id).update(updates)
                .then(() => { closeEditModal(); })
                .catch(err => alert("Gagal update data: " + err.message));
        }

        // --- 12. EXPORT UTILS ---
function exportGapImage() { 
    const container = document.getElementById('exportAreaContainer');
    
    // --- AMBIL DATA ---
    const val_Reg = document.getElementById('box-plan-reg').innerText;
    const val_ND = document.getElementById('box-plan-nd').innerText;
    const val_Real = document.getElementById('box-act-total').innerText;
    const val_SelfPlan = document.getElementById('box-plan-self').innerText;
    const val_SelfReal = document.getElementById('box-act-self').innerText;

    // --- DOM VARS ---
    let tempWrapper = null;
    let ambilBox = null;
    let flexWrapper = null;
    let parentAmbil = null;
    let originalAmbilWidth = ''; 
    let originalAmbilFlex = '';
    let originalAmbilHeight = ''; // Simpan tinggi asli

    if (container) {
        // 1. DETEKSI UKURAN TABEL ATAS
        const topTables = container.querySelectorAll('.gap-table-box');
        let targetWidthLeft = '50%'; 
        let targetWidthRight = '50%';

        if (topTables.length >= 2) {
            targetWidthLeft = topTables[0].offsetWidth + 'px';
            targetWidthRight = topTables[1].offsetWidth + 'px';
        } else if (topTables.length === 1) {
            targetWidthLeft = topTables[0].offsetWidth + 'px';
            targetWidthRight = targetWidthLeft;
        }

        // 2. BUAT WIDGET REKAP (LEBIH COMPACT AGAR TINGGI TIDAK JOMPLANG)
        tempWrapper = document.createElement('div');
        tempWrapper.style.boxSizing = 'border-box';
        tempWrapper.style.backgroundColor = '#1e3a8a'; 
        tempWrapper.style.borderRadius = '8px';
        // Padding diperkecil agar tidak terlalu tinggi
        tempWrapper.style.padding = '10px 15px'; 
        tempWrapper.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        tempWrapper.style.border = '1px solid rgba(255,255,255,0.1)';
        tempWrapper.style.color = '#ffffff';
        tempWrapper.style.fontFamily = "'Inter', sans-serif";
        tempWrapper.style.width = targetWidthRight; 
        tempWrapper.style.flex = 'none'; 
        tempWrapper.style.display = 'flex';
        tempWrapper.style.flexDirection = 'column';

        tempWrapper.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.15); padding-bottom: 5px;">
                <span style="font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px;"> REKAP TONASE (KG)</span>
            </div>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.65rem; flex: 1;">
                <thead>
                    <tr style="color: rgba(255,255,255,0.5);">
                        <th style="text-align: left; padding: 2px 0; font-weight: 500;">KATEGORI</th>
                        <th style="text-align: right; padding: 2px 15px 2px 0; font-weight: 500;">PLAN</th>
                        <th style="text-align: right; padding: 2px 0; font-weight: 500;">REALISASI</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 2px 0; font-weight: 600; opacity: 0.9;">Franco (Reg)</td>
                        <td style="padding: 2px 15px 2px 0; text-align: right; opacity: 0.9;">${val_Reg}</td>
                        <td rowspan="2" style="padding: 2px 0; text-align: right; vertical-align: middle; border-bottom: 1px solid rgba(255,255,255,0.2);">
                            <span style="font-size: 0.8rem; font-weight: 700; color: #a5f3fc;">${val_Real}</span>
                            <div style="font-size: 0.5rem; opacity: 0.6; line-height: 1;">(Total)</div>
                        </td>
                    </tr>
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                        <td style="padding: 2px 0; font-weight: 600; opacity: 0.9;">Next Day</td>
                        <td style="padding: 2px 15px 2px 0; text-align: right; opacity: 0.9;">${val_ND}</td>
                    </tr>
                    <tr>
                        <td style="padding: 6px 0 2px 0; font-weight: 600; opacity: 0.9;">Loco (Ambil)</td>
                        <td style="padding: 6px 15px 2px 0; text-align: right; opacity: 0.9;">${val_SelfPlan}</td>
                        <td style="padding: 6px 0 2px 0; text-align: right; color: #fca5a5; font-weight:600;">${val_SelfReal}</td>
                    </tr>
                </tbody>
            </table>
        `;

        // 3. PROSES POSISI BERDAMPINGAN
        const themeDarkBoxes = container.querySelectorAll('.theme-dark');
        themeDarkBoxes.forEach(box => {
            if(box.innerText.toUpperCase().includes('AMBIL SENDIRI')) {
                ambilBox = box;
            }
        });

        if (ambilBox) {
            parentAmbil = ambilBox.parentNode;
            
            // Simpan properti asli
            originalAmbilWidth = ambilBox.style.width;
            originalAmbilFlex = ambilBox.style.flex;
            originalAmbilHeight = ambilBox.style.height;

            // Buat Wrapper Flex
            flexWrapper = document.createElement('div');
            flexWrapper.style.display = 'flex';
            flexWrapper.style.gap = '15px';
            flexWrapper.style.alignItems = 'stretch'; // INI KUNCINYA: Memaksa tinggi sama
            flexWrapper.style.width = '100%'; 
            flexWrapper.style.marginTop = '20px';

            parentAmbil.insertBefore(flexWrapper, ambilBox);
            
            // ATUR AMBIL SENDIRI (KIRI)
            ambilBox.style.width = targetWidthLeft; 
            ambilBox.style.flex = 'none'; 
            ambilBox.style.display = 'flex'; // Agar box meregang
            ambilBox.style.flexDirection = 'column'; // Isi vertikal
            flexWrapper.appendChild(ambilBox);

            // ATUR REKAP TONASE (KANAN)
            flexWrapper.appendChild(tempWrapper);

        } else {
            tempWrapper.style.width = '100%';
            container.insertBefore(tempWrapper, container.firstChild);
        }
    }

    // --- PROSES FOTO ---
    const originalShadow = container.style.boxShadow;
    const originalBg = container.style.background;
    const originalPadding = container.style.padding;
    
    container.style.boxShadow = 'none';
    container.style.padding = '30px'; 
    container.style.backgroundColor = '#ffffff';

    html2canvas(container, { scale: 3 }).then(canvas => { 
        const link = document.createElement('a');
        link.download = 'ANALISIS_LOGISTIK_LENGKAP.jpg';
        link.href = canvas.toDataURL('image/jpeg', 1.0);
        link.click(); 
        
        // --- RESTORE ---
        container.style.boxShadow = originalShadow;
        container.style.background = originalBg;
        container.style.padding = originalPadding;
        
        if (flexWrapper && ambilBox) {
            parentAmbil.insertBefore(ambilBox, flexWrapper);
            ambilBox.style.width = originalAmbilWidth;
            ambilBox.style.flex = originalAmbilFlex;
            ambilBox.style.height = originalAmbilHeight;
            ambilBox.style.display = ''; // Reset display
            ambilBox.style.flexDirection = '';
            parentAmbil.removeChild(flexWrapper);
        } else if (tempWrapper && tempWrapper.parentNode) {
            tempWrapper.parentNode.removeChild(tempWrapper);
        }
    }); 
}

async function shareToWhatsApp(btnElement) {
    // --- VALIDASI ---
    const dateVal = document.getElementById('analysis-date').value;
    if (!dateVal) { alert("Pilih tanggal analisa dulu!"); return; }
    
    const dateObj = new Date(dateVal);
    const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const dateStr = `${dateObj.getDate()} ${months[dateObj.getMonth()]} ${dateObj.getFullYear()}`;

    // Helper Caption
    const getTableVal = (tbodyId, colIndex) => {
        const tbody = document.getElementById(tbodyId);
        if(!tbody) return '0';
        const totalRow = tbody.querySelector('tr:last-child'); 
        if (!totalRow) return '0';
        const cell = totalRow.children[colIndex];
        return cell ? cell.innerText.replace(/\n/g, '').trim() : '0'; 
    };

    const p_plan = getTableVal('body-plan-today', 1); const p_real = getTableVal('body-plan-today', 2); const p_gap  = getTableVal('body-plan-today', 3);
    const n_plan = getTableVal('body-next-day', 1); const n_real = getTableVal('body-next-day', 2); const n_gap  = getTableVal('body-next-day', 3);
    const t_plan = getTableVal('body-summary', 1); const t_real = getTableVal('body-summary', 2); const t_gap  = getTableVal('body-summary', 3);

    let msg = `Dear All,\nSelamat Pagi\n\nBerikut Update Delivery Plan ${dateStr}\n\n`;
    msg += `Planning,\nSampai Jam 17:00 : ${p_plan} Truck\nRealisasi : ${p_real} Truck\nGAP : ${p_gap} Truck\n\n`;
    msg += `Next Day : ${n_plan} Truck\nRealisasi : ${n_real} Truck\nGAP : ${n_gap} Truck\n\n`;
    msg += `-----\nTotal Plan & Next Day : ${t_plan} Truck\nRealisasi : ${t_real} Truck\nGAP : ${t_gap} Truck\n\nTerimakasih.`;

    // --- SETUP GAMBAR ---
    const container = document.getElementById('exportAreaContainer');
    const originalText = btnElement.innerHTML;
    btnElement.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Proses...';
    btnElement.disabled = true;

    const val_Reg = document.getElementById('box-plan-reg').innerText;
    const val_ND = document.getElementById('box-plan-nd').innerText;
    const val_Real = document.getElementById('box-act-total').innerText;
    const val_SelfPlan = document.getElementById('box-plan-self').innerText;
    const val_SelfReal = document.getElementById('box-act-self').innerText;

    // DOM VARS
    let tempWrapper = null;
    let ambilBox = null;
    let flexWrapper = null;
    let parentAmbil = null;
    let originalAmbilWidth = '';
    let originalAmbilFlex = '';
    let originalAmbilHeight = '';

    // 1. DETEKSI UKURAN
    const topTables = container.querySelectorAll('.gap-table-box');
    let targetWidthLeft = '50%'; 
    let targetWidthRight = '50%';

    if (topTables.length >= 2) {
        targetWidthLeft = topTables[0].offsetWidth + 'px';
        targetWidthRight = topTables[1].offsetWidth + 'px';
    } else if (topTables.length === 1) {
        targetWidthLeft = topTables[0].offsetWidth + 'px';
        targetWidthRight = targetWidthLeft;
    }

    // 2. WIDGET COMPACT
    tempWrapper = document.createElement('div');
    tempWrapper.style.boxSizing = 'border-box';
    tempWrapper.style.backgroundColor = '#1e3a8a'; 
    tempWrapper.style.borderRadius = '8px';
    tempWrapper.style.padding = '10px 15px'; // Compact padding
    tempWrapper.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
    tempWrapper.style.border = '1px solid rgba(255,255,255,0.1)';
    tempWrapper.style.color = '#ffffff';
    tempWrapper.style.fontFamily = "'Inter', sans-serif";
    tempWrapper.style.width = targetWidthRight;
    tempWrapper.style.flex = 'none';
    tempWrapper.style.display = 'flex';
    tempWrapper.style.flexDirection = 'column';

    tempWrapper.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.15); padding-bottom: 5px;">
            <span style="font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px;"> REKAP TONASE (KG)</span>
        </div>
        <table style="width: 100%; border-collapse: collapse; font-size: 0.65rem; flex: 1;">
            <thead>
                <tr style="color: rgba(255,255,255,0.5);">
                    <th style="text-align: left; padding: 2px 0; font-weight: 500;">KATEGORI</th>
                    <th style="text-align: right; padding: 2px 15px 2px 0; font-weight: 500;">PLAN</th>
                    <th style="text-align: right; padding: 2px 0; font-weight: 500;">REALISASI</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="padding: 2px 0; font-weight: 600; opacity: 0.9;">Franco (Reg)</td>
                    <td style="padding: 2px 15px 2px 0; text-align: right; opacity: 0.9;">${val_Reg}</td>
                    <td rowspan="2" style="padding: 2px 0; text-align: right; vertical-align: middle; border-bottom: 1px solid rgba(255,255,255,0.2);">
                        <span style="font-size: 0.8rem; font-weight: 700; color: #a5f3fc;">${val_Real}</span>
                        <div style="font-size: 0.5rem; opacity: 0.6; line-height: 1;">(Total)</div>
                    </td>
                </tr>
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                    <td style="padding: 2px 0; font-weight: 600; opacity: 0.9;">Next Day</td>
                    <td style="padding: 2px 15px 2px 0; text-align: right; opacity: 0.9;">${val_ND}</td>
                </tr>
                <tr>
                    <td style="padding: 6px 0 2px 0; font-weight: 600; opacity: 0.9;">Loco (Ambil)</td>
                    <td style="padding: 6px 15px 2px 0; text-align: right; opacity: 0.9;">${val_SelfPlan}</td>
                    <td style="padding: 6px 0 2px 0; text-align: right; color: #fca5a5; font-weight:600;">${val_SelfReal}</td>
                </tr>
            </tbody>
        </table>
    `;

    // 3. LAYOUTING
    const themeDarkBoxes = container.querySelectorAll('.theme-dark');
    themeDarkBoxes.forEach(box => {
        if(box.innerText.toUpperCase().includes('AMBIL SENDIRI')) {
            ambilBox = box;
        }
    });

    if (ambilBox) {
        parentAmbil = ambilBox.parentNode;
        originalAmbilWidth = ambilBox.style.width;
        originalAmbilFlex = ambilBox.style.flex;
        originalAmbilHeight = ambilBox.style.height;

        flexWrapper = document.createElement('div');
        flexWrapper.style.display = 'flex';
        flexWrapper.style.gap = '15px';
        flexWrapper.style.alignItems = 'stretch';
        flexWrapper.style.width = '100%';
        flexWrapper.style.marginTop = '20px';

        parentAmbil.insertBefore(flexWrapper, ambilBox);
        
        ambilBox.style.width = targetWidthLeft;
        ambilBox.style.flex = 'none';
        ambilBox.style.display = 'flex';
        ambilBox.style.flexDirection = 'column';
        flexWrapper.appendChild(ambilBox);
        flexWrapper.appendChild(tempWrapper);
    } else {
        tempWrapper.style.width = '100%';
        container.insertBefore(tempWrapper, container.firstChild);
    }

    try {
        const originalShadow = container.style.boxShadow;
        const originalBg = container.style.background;
        const originalPadding = container.style.padding;
        
        container.style.boxShadow = 'none';
        container.style.padding = '30px'; 
        container.style.backgroundColor = '#ffffff'; 

        const canvas = await html2canvas(container, { scale: 2, useCORS: true });
        
        container.style.boxShadow = originalShadow;
        container.style.background = originalBg; 
        container.style.padding = originalPadding;
        
        // RESTORE
        if (flexWrapper && ambilBox) {
            parentAmbil.insertBefore(ambilBox, flexWrapper);
            ambilBox.style.width = originalAmbilWidth;
            ambilBox.style.flex = originalAmbilFlex;
            ambilBox.style.height = originalAmbilHeight;
            ambilBox.style.display = '';
            ambilBox.style.flexDirection = '';
            parentAmbil.removeChild(flexWrapper);
        } else if (tempWrapper && tempWrapper.parentNode) {
            tempWrapper.parentNode.removeChild(tempWrapper);
        }

        canvas.toBlob(async (blob) => {
            const file = new File([blob], "Laporan_Logistik.png", { type: "image/png" });
            try { await navigator.clipboard.writeText(msg); } catch (e) {}

            if (navigator.share && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({ files: [file], title: 'Update Delivery', text: msg });
                } catch (err) { if (err.name !== 'AbortError') alert("Gagal share native."); }
            } else {
                alert(" GAMBAR BERHASIL DISALIN!\nPaste di WhatsApp (Caption sudah dicopy otomatis).");
                try {
                    const item = new ClipboardItem({ "image/png": blob });
                    await navigator.clipboard.write([item]);
                } catch (e) { window.open(canvas.toDataURL()); }
                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
            }
            btnElement.innerHTML = originalText;
            btnElement.disabled = false;
        });

    } catch (error) {
        console.error("Error:", error);
        // Emergency Restore
        if (flexWrapper && ambilBox && parentAmbil) {
             try { parentAmbil.insertBefore(ambilBox, flexWrapper); ambilBox.style.width = originalAmbilWidth; parentAmbil.removeChild(flexWrapper); } catch(e){}
        }
        alert("Terjadi kesalahan sistem.");
        btnElement.innerHTML = originalText;
        btnElement.disabled = false;
    }
}
        function exportToExcel() {
            const table = document.getElementById('dn-table-excel');
            const clone = table.cloneNode(true);
            const headers = clone.querySelectorAll('th');
            headers.forEach(th => { th.style.backgroundColor = "#0f172a"; th.style.color = "#ffffff"; th.style.border = "1px solid #000000"; });
            const cells = clone.querySelectorAll('td');
            cells.forEach(td => { td.style.border = "1px solid #000000"; if(td.classList.contains('col-number')) { td.style.textAlign = 'right'; td.style.fontWeight = 'bold'; } });
            
            const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(clone.outerHTML);
            const link = document.createElement('a');
            link.download = 'DATA_DN_LOGISTIK_MONITORING.xls';
            link.href = url; link.click();
        }

        function exportTableToImage() {
            const originalTable = document.getElementById('dn-table-excel');
            const filterVal = document.getElementById('filterStatus') ? document.getElementById('filterStatus').value : "";
            let subTitleText = filterVal ? `STATUS : ${filterVal.toUpperCase()}` : "SEMUA STATUS";
            
            const wrapper = document.createElement('div');
            wrapper.style.position = "fixed"; 
            wrapper.style.left = "-10000px"; 
            wrapper.style.top = "0"; 
            wrapper.style.zIndex = "9999";
            wrapper.style.backgroundColor = "#ffffff"; 
            wrapper.style.padding = "50px"; 
            wrapper.style.width = "1920px"; 
            wrapper.style.fontFamily = "'Inter', sans-serif";
            document.body.appendChild(wrapper);
            
            const headerBox = document.createElement('div');
            headerBox.innerHTML = `<h1 style="margin:0; color:#0f172a; font-size:24px;">DATA MONITORING DELIVERY</h1><h3 style="margin:5px 0 0 0; color:#64748b; font-size:16px;">${subTitleText}</h3><p style="margin:5px 0 20px 0; color:#94a3b8; font-size:12px;">Generated by InDeCo System</p>`;
            wrapper.appendChild(headerBox);
            
            const tableClone = originalTable.cloneNode(true);
            tableClone.removeAttribute('id'); 
            tableClone.style.width = "100%"; 
            tableClone.style.borderCollapse = "collapse"; 
            
            const pills = tableClone.querySelectorAll('.status-pill');
            pills.forEach(p => { 
                p.style.whiteSpace = "nowrap"; 
                p.style.display = "inline-block"; 
                p.style.width = "auto";
            });

            const thead = tableClone.querySelector('thead'); if (thead) thead.style.display = "table-header-group"; 
            
            const headers = tableClone.querySelectorAll('th');
            headers.forEach(th => { th.style.backgroundColor = "#0f172a"; th.style.color = "#ffffff"; th.style.padding = "10px"; th.style.border = "1px solid #cbd5e1"; th.style.fontSize = "12px"; if(th.innerText === "" || th.innerText === "Action" || th.innerText === "Edit") th.style.display = "none"; });
            
            const allRows = tableClone.querySelectorAll('tr');
            allRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                cells.forEach((td, index) => { 
                    td.style.border = "1px solid #e2e8f0"; td.style.padding = "8px"; td.style.fontSize = "12px"; td.style.color = "#334155";
                    if(index === 0 || index >= cells.length - 2) td.style.display = "none";
                });
            });
            
            wrapper.appendChild(tableClone);
            
            setTimeout(() => {
                html2canvas(wrapper, { scale: 3, backgroundColor: "#ffffff", windowWidth: 1920 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `LAPORAN_${subTitleText.replace(/\s|:/g, '_')}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    document.body.removeChild(wrapper);
                });
            }, 500); 
        }
    </script>
</body>
</html>
